<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Soul Confidant</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#111827" />

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="./icon-180.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="./icon-167.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="./icon-152.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="./icon-120.png" />
  <link rel="apple-touch-icon" href="./icon-180.png" />

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+SC:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #f472b6 0%, #a78bfa 100%);
      --user-msg-bg: linear-gradient(135deg, #ec4899, #be185d);
      --btn-bg: #ec4899;
      --icon-bg: linear-gradient(135deg, #f472b6 0%, #a78bfa 100%);
    }
    body.theme-male {
      --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
      --user-msg-bg: linear-gradient(135deg, #2563eb, #1d4ed8);
      --btn-bg: #2563eb;
      --icon-bg: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
    }

    body {
      font-family: 'Nunito', sans-serif;
      background-color: #111827;
      color: #e2e8f0;
      overflow: hidden;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      padding-top: env(safe-area-inset-top);
    }
    .app-container {
      width: 100%;
      height: 100dvh;
      background: linear-gradient(180deg, #1f2937 0%, #0f172a 100%);
      display: flex;
      flex-direction: column;
      position: relative;
      margin: 0 auto;
      max-width: 600px;
    }
    @media (min-width: 768px) {
      .app-container {
        border-left: 1px solid #374151;
        border-right: 1px solid #374151;
      }
    }

    /* Splash */
    .splash-screen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: radial-gradient(circle at center, #1e1b4b 0%, #0f172a 100%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease-out;
    }
    .splash-logo {
      font-size: 4.5rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }
    .splash-title { font-size: 2.2rem; font-weight: 900; color: white; letter-spacing: 1px; }
    .splash-subtitle { color: #94a3b8; font-size: 0.85rem; margin-top: 0.5rem; font-weight: 600; letter-spacing: 1px; }
    .splash-screen.fade-out { opacity: 0; pointer-events: none; }

    /* Modals */
    .modal-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(17, 24, 39, 0.98);
      z-index: 100;
      display: none;
      flex-direction: column;
      justify-content: center;
      padding: 24px;
    }
    .modal-overlay.active { display: flex; }
    .form-select {
      background-color: #1f2937;
      border: 1px solid #374151;
      color: white;
      padding: 12px;
      border-radius: 12px;
      width: 100%;
      margin-bottom: 12px;
      outline: none;
      transition: border-color 0.3s;
      font-size: 0.95rem;
    }
    .form-select:focus { border-color: #ec4899; }
    .lang-select-mini {
      background: #374151;
      color: white;
      border: 1px solid #4b5563;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      outline: none;
    }
    .legal-box {
      background: #111827;
      border: 1px solid #374151;
      padding: 15px;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #cbd5e1;
      margin-bottom: 20px;
      max-height: 250px;
      overflow-y: auto;
      line-height: 1.6;
    }

    /* Chat */
    .chat-area { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 40px; scroll-behavior: smooth; }
    .message-container { display: flex; flex-direction: column; width: 100%; margin-bottom: 16px; animation: popIn 0.3s ease; }
    .message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.5;
      position: relative;
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .message.user { align-self: flex-end; background: var(--user-msg-bg); color: white; border-bottom-right-radius: 2px; }
    .message.ai { align-self: flex-start; background: #334155; color: #f1f5f9; border-bottom-left-radius: 2px; border: 1px solid #475569; }

    /* Feedback */
    .feedback-container { display: flex; gap: 15px; margin-top: 6px; margin-left: 10px; opacity: 0.6; }
    .fb-btn { cursor: pointer; color: #6b7280; font-size: 1rem; transition: 0.2s; }
    .fb-btn:hover { color: white; transform: scale(1.2); }
    .fb-btn.liked { color: #34d399; }
    .fb-btn.disliked { color: #f87171; }

    /* Input */
    .input-area {
      background: #1f2937;
      padding: 16px;
      border-top: 1px solid #374151;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    .send-btn-custom {
      width: 50px; height: 50px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
      transition: 0.2s;
      background-color: var(--btn-bg);
      color: white;
    }
    .send-btn-custom:active { transform: scale(0.95); }

    .mode-switch {
      display: flex;
      background: #111827;
      padding: 4px;
      border-radius: 10px;
      margin-bottom: 5px;
      border: 1px solid #374151;
    }
    .mode-btn {
      flex: 1;
      padding: 8px;
      text-align: center;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      color: #6b7280;
      transition: 0.3s;
      user-select: none;
    }
    .mode-btn.active.advice { background: #374151; color: #f472b6; }
    .mode-btn.active.gossip { background: #4c1d95; color: #e9d5ff; }

    /* Header */
    .header-icon-bg { background: var(--icon-bg); }

    @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .typing-dots span { display: inline-block; width: 6px; height: 6px; background: #cbd5e1; border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* Fonts by lang */
    body.lang-ja { font-family: 'Noto Sans JP', sans-serif; }
    body.lang-zh { font-family: 'Noto Sans SC', sans-serif; }
    body.lang-ar { font-family: 'Noto Sans Arabic', sans-serif; direction: rtl; }

    /* Toast */
    .toast {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom, 0px) + 90px);
      background: rgba(17,24,39,0.92);
      border: 1px solid #374151;
      color: #e5e7eb;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      z-index: 99999;
      display: none;
      max-width: 92%;
      text-align: center;
    }
    .toast.show { display: block; }
  </style>
</head>

<body>
  <div id="mainApp" class="app-container">

    <!-- Splash -->
    <div id="splashScreen" class="splash-screen relative overflow-hidden">
      <canvas id="splashCanvas" class="absolute inset-0"></canvas>
      <div class="relative z-10 text-center px-4">
        <div class="splash-logo"><i class="fa-solid fa-ear-listen"></i></div>
        <h1 class="splash-title">SOUL CONFIDANT</h1>
        <p class="splash-subtitle">Generated with responsibility by ATAOL AI Techs</p>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Legal Modal -->
    <div id="legalModal" class="modal-overlay">
      <div class="w-full max-w-sm mx-auto mb-4 flex justify-end">
        <select id="legalLangSelect" class="lang-select-mini" onchange="app.changeAppLanguage(this.value)">
          <option value="tr">TÃ¼rkÃ§e</option>
          <option value="en" selected>English</option>
          <option value="de">Deutsch</option>
          <option value="fr">FranÃ§ais</option>
          <option value="es">EspaÃ±ol</option>
          <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="pt">PortuguÃªs</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="zh">ä¸­æ–‡</option>
        </select>
      </div>
      <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 w-full max-w-md mx-auto">
        <h2 id="legalTitle" class="text-xl font-bold text-white mb-4 text-center">Legal Disclaimer</h2>
        <div id="legalTextContent" class="legal-box"></div>
        <button id="legalBtn" onclick="app.acceptLegal()"
          class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl mt-2 transition">
          I Accept
        </button>
      </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay">
      <div class="w-full max-w-sm mx-auto">
        <div class="text-center mb-6">
          <div class="w-16 h-16 rounded-full header-icon-bg flex items-center justify-center text-white text-2xl mx-auto mb-3 shadow-lg transition-colors duration-500">
            <i class="fa-solid fa-user"></i>
          </div>
          <h2 id="profileTitle" class="text-xl font-bold text-white">Letâ€™s get to know you</h2>
          <p id="profileSubtitle" class="text-gray-400 text-xs mt-1">A safe place to talk.</p>
        </div>
        <form onsubmit="event.preventDefault(); app.submitProfile();">
          <select id="userGender" class="form-select" onchange="app.handleGenderChange(this.value)" required></select>
          <select id="userAge" class="form-select" required></select>
          <select id="userJob" class="form-select" required></select>
          <select id="userRelation" class="form-select" required></select>
          <select id="userMood" class="form-select" required></select>
          <button type="submit" id="startBtn"
            class="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold py-3 rounded-xl mt-4 shadow-lg transform active:scale-95 transition">
            Start <i class="fa-solid fa-arrow-right ml-2"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Header -->
    <header class="p-4 flex items-center justify-between border-b border-gray-700 bg-gray-900 z-10">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full header-icon-bg flex items-center justify-center text-white font-bold text-lg transition-colors duration-500">
          <i class="fa-solid fa-ear-listen"></i>
        </div>
        <div>
          <h1 id="appTitle" class="font-bold text-white">Soul Confidant</h1>
          <span id="appSubtitle" class="text-xs text-pink-400">A safe place to talk</span>
        </div>
      </div>
      <button onclick="app.clearChatHistory()"
        class="w-10 h-10 rounded-full border border-gray-600 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-800 transition">
        <i class="fa-solid fa-trash-can"></i>
      </button>
    </header>

    <!-- Chat -->
    <div id="chatBox" class="chat-area"></div>

    <!-- Input -->
    <div class="input-area">
      <div class="mode-switch">
        <div id="btnAdvice" class="mode-btn active advice" onclick="app.setMode('advice')">
          <i class="fa-solid fa-heart mr-1"></i> <span id="labelAdvice">Vent</span>
        </div>
        <div id="btnGossip" class="mode-btn gossip" onclick="app.setMode('gossip')">
          <i class="fa-solid fa-bolt mr-1"></i> <span id="labelGossip">Gossip</span>
        </div>
      </div>

      <div class="flex gap-2 items-end">
        <textarea id="userInput" rows="2"
          class="w-full bg-gray-800 text-white rounded-xl px-4 py-3 border border-gray-600 focus:border-pink-500 outline-none resize-none text-sm"
          placeholder="Type here..."></textarea>
        <button id="sendBtn" onclick="app.sendMessage()" class="send-btn-custom text-white">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // CONFIG
    // =========================================================
    const BACKEND_URL = "https://dert-sirdasi-api.captsertacgul.workers.dev"; // <-- gerekirse deÄŸiÅŸtir

    // =========================================================
    // Splash Canvas Effect
    // =========================================================
    const CanvasEffect = {
      canvas: null, ctx: null, particles: [], animationId: null,
      init() {
        this.canvas = document.getElementById('splashCanvas');
        if (!this.canvas) return;
        this.ctx = this.canvas.getContext('2d');
        if (!this.ctx) return;
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.createParticles();
        this.animate();
      },
      resize() {
        if (!this.canvas) return;
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
      },
      createParticles() {
        if (!this.canvas) return;
        const count = Math.floor((this.canvas.width * this.canvas.height) / 10000);
        this.particles = [];
        for (let i = 0; i < count; i++) {
          this.particles.push({
            x: Math.random() * this.canvas.width,
            y: Math.random() * this.canvas.height,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5,
            size: Math.random() * 2 + 1,
            alpha: Math.random() * 0.5 + 0.1
          });
        }
      },
      animate() {
        if (!this.ctx) return;
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        for (const p of this.particles) {
          p.x += p.vx; p.y += p.vy;
          if (p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
          if (p.y < 0 || p.y > this.canvas.height) p.vy *= -1;
          this.ctx.fillStyle = `rgba(167, 139, 250, ${p.alpha})`;
          this.ctx.beginPath();
          this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          this.ctx.fill();
        }
        this.animationId = requestAnimationFrame(() => this.animate());
      },
      stop() { if (this.animationId) cancelAnimationFrame(this.animationId); }
    };

    // =========================================================
    // Translations
    // =========================================================
    const Translations = {
      tr: {
        appTitle:"Dert SÄ±rdaÅŸÄ±", appSubtitle:"Seninle konuÅŸmak iyi gelecek",
        labelAdvice:"DertleÅŸme", labelGossip:"GÄ±ybet", placeholder:"Yaz bakalÄ±m...",
        legalTitle:"Yasal UyarÄ±",
        legalText:`<ul>
          <li><strong>1. YaÅŸ SÄ±nÄ±rÄ±:</strong> 18+ yaÅŸ gereklidir.</li>
          <li><strong>2. Sorumluluk Reddi:</strong> Yapay zeka simÃ¼lasyonudur.</li>
          <li><strong>3. Etik:</strong> SaygÄ±lÄ± dil kullanÄ±nÄ±z.</li>
          <li><strong>4. Gizlilik:</strong> Veriler cihazÄ±nÄ±zda saklanÄ±r.</li>
          <li><strong>5. RÄ±za:</strong> Kullanarak ÅŸartlarÄ± kabul edersiniz.</li>
        </ul>`,
        legalBtn:"Kabul Ediyorum",
        clearMsg:"Sohbet geÃ§miÅŸi silinsin mi?",
        intro:"Merhaba, seni dinliyorum.",
        followup:"DÃ¼n konuÅŸtuÄŸumuz konu ne durumda? Ä°stersen kaldÄ±ÄŸÄ±mÄ±z yerden devam edelim.",
        profileTitle:"Seni TanÄ±yalÄ±m", profileSubtitle:"YargÄ±sÄ±z, gÃ¼venli dert ortaÄŸÄ±n.", startBtn:"BaÅŸla",
        gender:["Cinsiyet", "KadÄ±n", "Erkek", "Belirtme"],
        age:["YaÅŸ","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["Meslek", "Ã–ÄŸrenci", "Ã‡alÄ±ÅŸan", "Ev HanÄ±mÄ±", "Ä°ÅŸsiz", "Emekli"],
        relation:["Ä°liÅŸki", "Bekar", "Ä°liÅŸkisi Var", "Evli", "KarmaÅŸÄ±k"],
        mood:["Ruh halin nasÄ±l?", "Mutlu", "ÃœzgÃ¼n", "KÄ±zgÄ±n", "Yorgun", "NÃ¶tr"],
        netErr:"Sunucuya baÄŸlanamadÄ±m. Tekrar dener misin?",
        limitErr:"GÃ¼nlÃ¼k Ã¼cretsiz mesaj hakkÄ±n doldu. YarÄ±n tekrar buradayÄ±m ğŸ«¶"
      },
      en: {
        appTitle:"Soul Confidant", appSubtitle:"A safe place to talk",
        labelAdvice:"Vent", labelGossip:"Gossip", placeholder:"Type here...",
        legalTitle:"Legal Disclaimer",
        legalText:`<ul>
          <li><strong>1. Age Limit:</strong> 18+ required.</li>
          <li><strong>2. Disclaimer:</strong> AI simulation.</li>
          <li><strong>3. Ethics:</strong> Respectful language only.</li>
          <li><strong>4. Privacy:</strong> Local data storage.</li>
          <li><strong>5. Consent:</strong> By using, you accept terms.</li>
        </ul>`,
        legalBtn:"I Accept",
        clearMsg:"Clear chat history?",
        intro:"Hello. I'm here for you. Tell me what's on your mind.",
        followup:"How did things go with what you shared yesterday? Want to continue from there?",
        profileTitle:"Letâ€™s get to know you", profileSubtitle:"A safe place to talk.", startBtn:"Start",
        gender:["Gender", "Female", "Male", "Prefer not to say"],
        age:["Age","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["Job", "Student", "Worker", "Homemaker", "Unemployed", "Retired"],
        relation:["Relationship", "Single", "In a relationship", "Married", "Complicated"],
        mood:["Mood", "Happy", "Sad", "Angry", "Tired", "Neutral"],
        netErr:"I couldn't reach the server. Please try again.",
        limitErr:"Youâ€™ve reached todayâ€™s free limit. Come back tomorrow ğŸ«¶"
      },
      de: { appTitle:"Soul Confidant", appSubtitle:"Ein sicherer Ort", labelAdvice:"Reden", labelGossip:"Klatsch", placeholder:"Schreiben...", legalTitle:"Hinweis", legalText:"<p>18+.</p>", legalBtn:"OK", clearMsg:"LÃ¶schen?", intro:"Hallo, ich hÃ¶re zu.", followup:"Wie lief es mit dem Thema von gestern?", profileTitle:"Profil", profileSubtitle:"Sicherer Raum.", startBtn:"Start", gender:["Geschlecht","Weiblich","MÃ¤nnlich","k.A."], age:["Alter","18-24","25-34","35-44","45-54","55-64","65-75","75+"], job:["Beruf","Student","Arbeit","Hausfrau","Arbeitslos","Rentner"], relation:["Status","Single","Beziehung","Verheiratet","Kompliziert"], mood:["Stimmung","Gut","Schlecht","WÃ¼tend","MÃ¼de","Neutral"], netErr:"Server nicht erreichbar.", limitErr:"Tageslimit erreicht." },
      fr: { appTitle:"Soul Confidant", appSubtitle:"Un espace sÃ»r", labelAdvice:"Confier", labelGossip:"Potins", placeholder:"Ã‰crivez...", legalTitle:"Avis", legalText:"<p>18+.</p>", legalBtn:"OK", clearMsg:"Effacer?", intro:"Bonjour, je vous Ã©coute.", followup:"Et le sujet dâ€™hier, Ã§a va mieux ?", profileTitle:"Profil", profileSubtitle:"Espace sÃ»r.", startBtn:"Commencer", gender:["Genre","Femme","Homme","N/A"], age:["Ã‚ge","18-24","25-34","35-44","45-54","55-64","65-75","75+"], job:["Emploi","Ã‰tudiant","Travail","Au foyer","Sans emploi","RetraitÃ©"], relation:["Statut","CÃ©libataire","En couple","MariÃ©","CompliquÃ©"], mood:["Humeur","Bien","Mal","FÃ¢chÃ©","FatiguÃ©","Neutre"], netErr:"Serveur indisponible.", limitErr:"Limite atteinte." },
      es: { appTitle:"Soul Confidant", appSubtitle:"Un lugar seguro", labelAdvice:"Desahogarse", labelGossip:"Chisme", placeholder:"Escribe...", legalTitle:"Aviso", legalText:"<p>18+.</p>", legalBtn:"OK", clearMsg:"Â¿Borrar?", intro:"Hola, te escucho.", followup:"Â¿QuÃ© tal lo de ayer?", profileTitle:"Perfil", profileSubtitle:"Seguro.", startBtn:"Iniciar", gender:["GÃ©nero","Mujer","Hombre","N/A"], age:["Edad","18-24","25-34","35-44","45-54","55-64","65-75","75+"], job:["Trabajo","Estudiante","Trabajo","Hogar","Desempleado","Jubilado"], relation:["Estado","Soltero","En pareja","Casado","Complicado"], mood:["Ãnimo","Bien","Mal","Enojado","Cansado","Neutral"], netErr:"Servidor no disponible.", limitErr:"LÃ­mite alcanzado." },
      ru: { appTitle:"Soul Confidant", appSubtitle:"Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğµ Ğ¼ĞµÑÑ‚Ğ¾", labelAdvice:"ĞŸĞ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ", labelGossip:"Ğ¡Ğ¿Ğ»ĞµÑ‚Ğ½Ğ¸", placeholder:"ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ...", legalTitle:"Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ", legalText:"<p>18+.</p>", legalBtn:"OK", clearMsg:"ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ?", intro:"Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ, Ñ ÑĞ»ÑƒÑˆĞ°Ñ.", followup:"ĞšĞ°Ğº Ğ´ĞµĞ»Ğ° Ñ Ñ‚ĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ²Ñ‡ĞµÑ€Ğ°?", profileTitle:"ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", profileSubtitle:"Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾.", startBtn:"ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ", gender:["ĞŸĞ¾Ğ»","Ğ–ĞµĞ½ÑĞºĞ¸Ğ¹","ĞœÑƒĞ¶ÑĞºĞ¾Ğ¹","N/A"], age:["Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚","18-24","25-34","35-44","45-54","55-64","65-75","75+"], job:["Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°","Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚","Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ","Ğ”Ğ¾Ğ¼","Ğ‘ĞµĞ· Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹","ĞŸĞµĞ½ÑĞ¸Ñ"], relation:["Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ","Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´ĞµĞ½","Ğ’ Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸ÑÑ…","Ğ–ĞµĞ½Ğ°Ñ‚/Ğ—Ğ°Ğ¼ÑƒĞ¶ĞµĞ¼","Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾"], mood:["ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ","Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾","ĞŸĞ»Ğ¾Ñ…Ğ¾","Ğ—Ğ»ÑÑÑŒ","Ğ£ÑÑ‚Ğ°Ğ»","ĞĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾"], netErr:"Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½.", limitErr:"Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚." },
      ja: { appTitle:"Soul Confidant", appSubtitle:"å®‰å¿ƒã—ã¦è©±ã›ã‚‹", labelAdvice:"ç›¸è«‡", labelGossip:"å™‚", placeholder:"å…¥åŠ›...", legalTitle:"å…è²¬", legalText:"<p>18+.</p>", legalBtn:"OK", clearMsg:"å‰Šé™¤ï¼Ÿ", intro:"ã“ã‚“ã«ã¡ã¯ã€‚èã„ã¦ã‚‹ã‚ˆã€‚", followup:"æ˜¨æ—¥ã®ã“ã¨ã€ãã®å¾Œã©ã†ï¼Ÿ", profileTitle:"ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«", profileSubtitle:"å®‰å…¨ãªå ´æ‰€ã€‚", startBtn:"é–‹å§‹", gender:["æ€§åˆ¥","å¥³æ€§","ç”·æ€§","æœªå›ç­”"], age:["å¹´é½¢","18-24","25-34","35-44","45-54","55-64","65-75","75+"], job:["è·æ¥­","å­¦ç”Ÿ","ä¼šç¤¾å“¡","ä¸»å©¦","ç„¡è·","é€€è·"], relation:["é–¢ä¿‚","ç‹¬èº«","äº¤éš›ä¸­","æ—¢å©š","è¤‡é›‘"], mood:["æ°—åˆ†","è‰¯ã„","æ‚ªã„","æ€’ã‚Š","ç–²ã‚Œ","æ™®é€š"], netErr:"ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚", limitErr:"æœ¬æ—¥ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚" },
      pt: { appTitle:"Soul Confidant", appSubtitle:"Um lugar seguro", labelAdvice:"Desabafar", labelGossip:"Fofoca", placeholder:"Digite...", legalTitle:"Aviso", legalText:"<p>18+.</p>", legalBtn:"OK", clearMsg:"Limpar?", intro:"OlÃ¡, estou aqui.", followup:"E o assunto de ontem, como ficou?", profileTitle:"Perfil", profileSubtitle:"Seguro.", startBtn:"Iniciar", gender:["GÃªnero","Feminino","Masculino","N/A"], age:["Idade","18-24","25-34","35-44","45-54","55-64","65-75","75+"], job:["Trabalho","Estudante","Trabalho","Do lar","Desempregado","Aposentado"], relation:["Status","Solteiro","Em relacionamento","Casado","Complicado"], mood:["Humor","Bem","Mal","Bravo","Cansado","Neutro"], netErr:"Servidor indisponÃ­vel.", limitErr:"Limite atingido." },
      ar: { appTitle:"Soul Confidant", appSubtitle:"Ù…ÙƒØ§Ù† Ø¢Ù…Ù†", labelAdvice:"ÙØ¶ÙØ¶Ø©", labelGossip:"Ø¯Ø±Ø¯Ø´Ø©", placeholder:"Ø§ÙƒØªØ¨...", legalTitle:"ØªÙ†Ø¨ÙŠÙ‡", legalText:"<p>18+.</p>", legalBtn:"OK", clearMsg:"Ù…Ø³Ø­ØŸ", intro:"Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ Ø£Ø³ØªÙ…Ø¹.", followup:"ÙƒÙŠÙ ÙƒØ§Ù† Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø£Ù…Ø³ØŸ", profileTitle:"Ø§Ù„Ù…Ù„Ù", profileSubtitle:"Ø¢Ù…Ù†.", startBtn:"Ø§Ø¨Ø¯Ø£", gender:["Ø§Ù„Ø¬Ù†Ø³","Ø£Ù†Ø«Ù‰","Ø°ÙƒØ±","ØºÙŠØ± Ù…Ø­Ø¯Ø¯"], age:["Ø§Ù„Ø¹Ù…Ø±","18-24","25-34","35-44","45-54","55-64","65-75","75+"], job:["Ø§Ù„Ø¹Ù…Ù„","Ø·Ø§Ù„Ø¨","Ù…ÙˆØ¸Ù","Ø±Ø¨Ø© Ù…Ù†Ø²Ù„","Ø¹Ø§Ø·Ù„","Ù…ØªÙ‚Ø§Ø¹Ø¯"], relation:["Ø§Ù„Ø­Ø§Ù„Ø©","Ø£Ø¹Ø²Ø¨","Ù…Ø±ØªØ¨Ø·","Ù…ØªØ²ÙˆØ¬","Ù…Ø¹Ù‚Ø¯"], mood:["Ø§Ù„Ù…Ø²Ø§Ø¬","Ø¬ÙŠØ¯","Ø³ÙŠØ¡","ØºØ§Ø¶Ø¨","Ù…ØªØ¹Ø¨","Ù…Ø­Ø§ÙŠØ¯"], netErr:"ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….", limitErr:"ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ." },
      zh: { appTitle:"Soul Confidant", appSubtitle:"å®‰å…¨å€¾è¯‰ç©ºé—´", labelAdvice:"å€¾è¯‰", labelGossip:"å…«å¦", placeholder:"è¾“å…¥...", legalTitle:"å£°æ˜", legalText:"<p>18+.</p>", legalBtn:"OK", clearMsg:"æ¸…é™¤ï¼Ÿ", intro:"ä½ å¥½ï¼Œæˆ‘åœ¨å¬ã€‚", followup:"æ˜¨å¤©çš„äº‹ï¼Œåæ¥æ€ä¹ˆæ ·ï¼Ÿ", profileTitle:"èµ„æ–™", profileSubtitle:"å®‰å…¨ã€‚", startBtn:"å¼€å§‹", gender:["æ€§åˆ«","å¥³","ç”·","ä¸é€éœ²"], age:["å¹´é¾„","18-24","25-34","35-44","45-54","55-64","65-75","75+"], job:["èŒä¸š","å­¦ç”Ÿ","å·¥ä½œ","å®¶åº­ä¸»å¦‡","å¤±ä¸š","é€€ä¼‘"], relation:["çŠ¶æ€","å•èº«","æ‹çˆ±ä¸­","å·²å©š","å¤æ‚"], mood:["å¿ƒæƒ…","å¥½","å","ç”Ÿæ°”","ç´¯","ä¸€èˆ¬"], netErr:"æ— æ³•è¿æ¥æœåŠ¡å™¨ã€‚", limitErr:"å·²è¾¾åˆ°ä»Šæ—¥ä¸Šé™ã€‚" }
    };

    // =========================================================
    // Storage + state
    // =========================================================
    const StoreKeys = {
      history: "sc_history_v1",
      profile: "sc_profile_v1",
      followup: "sc_followup_v1" // { lastDateISO, lastTopic }
    };

    const AIController = {
      history: [],
      userProfile: {},
      genderMode: "female",

      loadData() {
        try {
          const h = localStorage.getItem(StoreKeys.history);
          if (h) this.history = JSON.parse(h);
          const p = localStorage.getItem(StoreKeys.profile);
          if (p) this.userProfile = JSON.parse(p);
          return !!p;
        } catch (e) { return false; }
      },
      saveHistory() { localStorage.setItem(StoreKeys.history, JSON.stringify(this.history)); },
      saveProfile(p) { localStorage.setItem(StoreKeys.profile, JSON.stringify(p)); this.userProfile = p; },
      clear() {
        this.history = [];
        localStorage.removeItem(StoreKeys.history);
        localStorage.removeItem(StoreKeys.profile);
        // followup'Ä± da temizle
        localStorage.removeItem(StoreKeys.followup);
      },

      addUserMessage(text) {
        this.history.push({ role: "user", text, ts: Date.now() });
        if (this.history.length > 60) this.history = this.history.slice(-60);
        this.saveHistory();
      },
      addAIMessage(text) {
        this.history.push({ role: "ai", text, ts: Date.now() });
        if (this.history.length > 60) this.history = this.history.slice(-60);
        this.saveHistory();
      },

      // DÃ¼n konuÅŸulan konuyu sakla (son user mesajÄ±nÄ± "topic" say)
      updateFollowupTopicFromUserText(userText) {
        try {
          const payload = {
            lastDateISO: new Date().toISOString().slice(0,10), // YYYY-MM-DD
            lastTopic: (userText || "").slice(0, 500)
          };
          localStorage.setItem(StoreKeys.followup, JSON.stringify(payload));
        } catch(e) {}
      },

      // Backend Ã§aÄŸrÄ±sÄ±
      const res = await AIController.generate(txt, app.currentMode);
      <script>
const API_ENDPOINT = "https://dert-sirdasi-api.captsertacgul.workers.dev";

const AIController = {
  history: [],

  async generate(message, mode = "advice") {
    try {
      const res = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message,
          mode
        })
      });

      const data = await res.json();

      if (!res.ok) {
        return data.reply || "Sunucu hatasÄ± oluÅŸtu.";
      }

      return data.reply;

    } catch (err) {
      return "Sunucuya baÄŸlanamadÄ±m. Tekrar dener misin?";
    }
  }
};
</script>

      async generate(message, mode) {
        // ekstra alanlar backend gÃ¶rmezden gelebilir
        const body = {
          message,
          mode,
          profile: this.userProfile,
          // kÄ±sa context: son 10 mesaj
          history: this.history.slice(-10)
        };

        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        // Limit
        if (res.status === 429) {
          return { ok: false, code: 429, reply: (Translations[app.lang] || Translations.en).limitErr };
        }

        if (!res.ok) {
          let txt = "";
          try { txt = await res.text(); } catch(e) {}
          return { ok: false, code: res.status, reply: (Translations[app.lang] || Translations.en).netErr, debug: txt };
        }

        const data = await res.json().catch(() => ({}));
        const reply = data.reply || data.text || data.message || "";
        return { ok: true, code: 200, reply: reply || (Translations[app.lang] || Translations.en).netErr };
      }
    };

    // =========================================================
    // App UI
    // =========================================================
    const app = {
      lang: "en",
      currentMode: "advice",
      sendLock: false,

      init() {
        this.chatBox = document.getElementById("chatBox");
        this.input = document.getElementById("userInput");

        try { CanvasEffect.init(); } catch(e) {}

        // Enter ile gÃ¶nder (shift+enter yeni satÄ±r)
        this.input.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });

        const hasProfile = AIController.loadData();

        // dil
        if (AIController.userProfile && AIController.userProfile.language) {
          this.lang = AIController.userProfile.language;
          const sel = document.getElementById("legalLangSelect");
          if (sel) sel.value = this.lang;
        }

        this.updateLang(this.lang);

        setTimeout(() => {
          const sp = document.getElementById("splashScreen");
          if (sp) {
            sp.classList.add("fade-out");
            setTimeout(() => sp.style.display = "none", 600);
          }
          this.checkFlow(hasProfile);
        }, 1200);
      },

      toast(msg, ms=2200) {
        const t = document.getElementById("toast");
        if (!t) return;
        t.innerText = msg;
        t.classList.add("show");
        clearTimeout(this._toastTimer);
        this._toastTimer = setTimeout(() => t.classList.remove("show"), ms);
      },

      checkFlow(hasProfile) {
        const legal = document.getElementById("legalModal");
        if (legal) legal.classList.add("active");

        // restore theme
        if (AIController.userProfile && AIController.userProfile.gender) {
          this.updateTheme(AIController.userProfile.gender);
        }

        // geÃ§miÅŸi varsa yÃ¼kle
        if (hasProfile && AIController.history.length > 0) {
          // yasal kabulden sonra restore edeceÄŸiz
        }
      },

      changeAppLanguage(val) { this.lang = val; this.updateLang(val); },

      updateLang(l) {
        const t = Translations[l] || Translations.en;

        const setT = (id, v) => { const el = document.getElementById(id); if (el) el.innerText = v || ""; };
        const setH = (id, v) => { const el = document.getElementById(id); if (el) el.innerHTML = v || ""; };

        setT("legalTitle", t.legalTitle);
        setH("legalTextContent", t.legalText);
        setT("legalBtn", t.legalBtn);

        setT("profileTitle", t.profileTitle);
        setT("profileSubtitle", t.profileSubtitle);

        setT("appTitle", t.appTitle);
        setT("appSubtitle", t.appSubtitle);
        setT("labelAdvice", t.labelAdvice);
        setT("labelGossip", t.labelGossip);

        const inp = document.getElementById("userInput");
        if (inp) inp.placeholder = t.placeholder;

        this.fillSelect("userGender", t.gender);
        this.fillSelect("userAge", t.age);
        this.fillSelect("userJob", t.job);
        this.fillSelect("userRelation", t.relation);
        this.fillSelect("userMood", t.mood);

        // body lang class
        document.body.classList.remove("lang-ar", "lang-ja", "lang-zh");
        if (l === "ar") document.body.classList.add("lang-ar");
        if (l === "ja") document.body.classList.add("lang-ja");
        if (l === "zh") document.body.classList.add("lang-zh");
      },

      fillSelect(id, opts) {
        const sel = document.getElementById(id);
        if (!sel || !Array.isArray(opts)) return;
        const prev = sel.value;
        sel.innerHTML = "";
        opts.forEach((o, i) => {
          const op = document.createElement("option");
          op.value = o;
          op.innerText = o;
          if (i === 0) { op.disabled = true; op.selected = true; }
          sel.add(op);
        });
        // restore if possible
        if (prev && opts.includes(prev)) sel.value = prev;
      },

      acceptLegal() {
        // dil kaydet
        const sel = document.getElementById("legalLangSelect");
        if (sel) this.lang = sel.value;

        const legal = document.getElementById("legalModal");
        if (legal) legal.classList.remove("active");

        // profil var mÄ±?
        if (AIController.userProfile && AIController.userProfile.age) {
          AIController.userProfile.language = this.lang;
          AIController.saveProfile(AIController.userProfile);
          this.updateLang(this.lang);

          // chat restore
          if (AIController.history.length > 0) this.restoreChat();
          else {
            const t = Translations[this.lang] || Translations.en;
            setTimeout(() => this.addBubble(t.intro, "ai"), 400);
          }

          // follow-up check
          setTimeout(() => this.maybeAskYesterdayFollowup(), 700);

        } else {
          this.updateLang(this.lang);
          const pm = document.getElementById("profileModal");
          if (pm) pm.classList.add("active");
        }
      },

      handleGenderChange(val) {
        this.updateTheme(val);

        // Ev HanÄ±mÄ± filtre (erkekse)
        const t = Translations[this.lang] || Translations.en;
        this.fillSelect("userJob", t.job);

        const isMale = (val || "").toLowerCase().includes("erkek") || (val || "").toLowerCase().includes("male");
        if (isMale) {
          const jobSel = document.getElementById("userJob");
          if (!jobSel) return;
          for (let i = 0; i < jobSel.options.length; i++) {
            const txt = jobSel.options[i].value || "";
            if (txt.includes("HanÄ±m") || txt.includes("Homemaker") || txt.includes("Hausfrau")) {
              jobSel.remove(i); i--;
            }
          }
        }
      },

      updateTheme(val) {
        const v = (val || "").toLowerCase();
        const isMale = v.includes("erkek") || v.includes("male");
        if (isMale) {
          document.body.classList.add("theme-male");
          AIController.genderMode = "male";
        } else {
          document.body.classList.remove("theme-male");
          AIController.genderMode = (v.includes("kadÄ±n") || v.includes("female")) ? "female" : "neutral";
        }
      },

      submitProfile() {
        const g = document.getElementById("userGender").value;
        const a = document.getElementById("userAge").value;

        if (document.getElementById("userAge").selectedIndex === 0) { alert("Select"); return; }

        const p = {
          gender: g, age: a, language: this.lang,
          job: document.getElementById("userJob").value,
          relation: document.getElementById("userRelation").value,
          mood: document.getElementById("userMood").value
        };

        AIController.saveProfile(p);
        this.updateTheme(g);

        const pm = document.getElementById("profileModal");
        if (pm) pm.classList.remove("active");

        setTimeout(() => {
          const t = Translations[this.lang] || Translations.en;
          let txt = t.intro;
          const ml = (p.mood || "").toLowerCase();
          if (ml.includes("Ã¼zgÃ¼n") || ml.includes("sad")) txt += " ğŸ˜”";
          else if (ml.includes("mutlu") || ml.includes("happy")) txt += " ğŸ˜ƒ";
          else if (ml.includes("kÄ±zgÄ±n") || ml.includes("angry")) txt += " ğŸ˜¡";
          this.addBubble(txt, "ai");
        }, 500);
      },

      clearChatHistory() {
        const t = Translations[this.lang] || Translations.en;
        if (confirm(t.clearMsg)) {
          AIController.clear();
          this.chatBox.innerHTML = "";
          location.reload();
        }
      },

      restoreChat() {
        this.chatBox.innerHTML = "";
        for (const m of AIController.history) {
          if (!m || !m.text) continue;
          const type = (m.role === "user") ? "user" : "ai";
          this.addBubble(m.text, type, true);
        }
        setTimeout(() => this.scrollToBottom(), 100);
      },

      setMode(m) {
        this.currentMode = m;
        document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
        const btn = document.getElementById(m === "advice" ? "btnAdvice" : "btnGossip");
        if (btn) btn.classList.add("active");
      },

      addBubble(txt, type, noAnim=false) {
        const box = this.chatBox;

        const wrap = document.createElement("div");
        wrap.className = "message-container";

        const bubble = document.createElement("div");
        bubble.className = `message ${type}`;
        if (noAnim) bubble.style.animation = "none";
        bubble.innerHTML = (txt || "").replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");

        wrap.appendChild(bubble);

        if (type === "ai" && !noAnim) {
          const fb = document.createElement("div");
          fb.className = "feedback-container";
          fb.innerHTML = `
            <i class="fa-regular fa-thumbs-up fb-btn" onclick="this.classList.toggle('liked')"></i>
            <i class="fa-regular fa-thumbs-down fb-btn" onclick="this.classList.toggle('disliked')"></i>
          `;
          wrap.appendChild(fb);
        }

        box.appendChild(wrap);
        this.scrollToBottom();
      },

      showTyping(id) {
        const box = this.chatBox;
        const d = document.createElement("div");
        d.id = id;
        d.className = "message ai opacity-50";
        d.style.width = "60px";
        d.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
        box.appendChild(d);
        this.scrollToBottom();
      },

      scrollToBottom() {
        const b = this.chatBox;
        b.scrollTop = b.scrollHeight;
      },

      // DÃ¼n followup
      maybeAskYesterdayFollowup() {
        try {
          const raw = localStorage.getItem(StoreKeys.followup);
          if (!raw) return;

          const data = JSON.parse(raw);
          if (!data || !data.lastDateISO || !data.lastTopic) return;

          // bugÃ¼n
          const today = new Date();
          const todayISO = today.toISOString().slice(0,10);

          // dÃ¼n
          const y = new Date(today);
          y.setDate(today.getDate() - 1);
          const yISO = y.toISOString().slice(0,10);

          // eÄŸer kayÄ±t tarihi "dÃ¼n" ise sor
          if (data.lastDateISO === yISO) {
            const t = Translations[this.lang] || Translations.en;
            this.addBubble(t.followup, "ai");
          }
        } catch(e) {}
      },

      async sendMessage() {
        if (this.sendLock) return;

        const txt = (this.input.value || "").trim();
        if (!txt) return;

        this.sendLock = true;

        // UI + local
        this.addBubble(txt, "user");
        this.input.value = "";
        AIController.addUserMessage(txt);
        AIController.updateFollowupTopicFromUserText(txt);

        const tid = "t-" + Date.now();
        this.showTyping(tid);

        // backend
        let result;
        try {
          result = await AIController.generate(txt, this.currentMode);
        } catch (e) {
          result = { ok: false, code: 0, reply: (Translations[this.lang] || Translations.en).netErr };
        }

        const te = document.getElementById(tid);
        if (te) te.remove();

        if (!result.ok) {
          // 429 -> toast + AI bubble
          if (result.code === 429) {
            this.addBubble(result.reply, "ai");
          } else {
            this.toast(result.reply);
            this.addBubble(result.reply, "ai");
          }
          AIController.addAIMessage(result.reply);
          this.sendLock = false;
          return;
        }

        this.addBubble(result.reply, "ai");
        AIController.addAIMessage(result.reply);

        this.sendLock = false;
      }
    };

    window.addEventListener("load", () => app.init());
  </script>
</body>
</html>

