<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Soul Confidant</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{background:#0f172a;color:#e5e7eb;font-family:Nunito,sans-serif}
.message{max-width:80%;padding:12px 16px;border-radius:18px;margin-bottom:12px}
.user{align-self:flex-end;background:#2563eb;color:white}
.ai{align-self:flex-start;background:#334155}
.typing span{display:inline-block;width:6px;height:6px;background:#cbd5e1;border-radius:50%;margin:0 2px;animation:bounce 1.4s infinite}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
</style>
</head>

<body>
<div class="max-w-xl mx-auto h-screen flex flex-col">

<header class="p-4 border-b border-gray-700">
<h1 class="font-bold text-lg">Soul Confidant</h1>
<p class="text-sm text-pink-400">A safe place to talk</p>
</header>

<div id="chat" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>

<div class="p-4 border-t border-gray-700 flex gap-2">
<textarea id="input" class="flex-1 bg-gray-800 rounded p-2" rows="2"></textarea>
<button id="send" class="bg-pink-600 px-4 rounded text-white">
<i class="fa fa-paper-plane"></i>
</button>
</div>

</div>

<script>
const API_URL = "https://dert-sirdasi-api.captsertacgul.workers.dev";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");

const STORE_KEY = "sc_last_topic";

function addBubble(text,type){
  const div=document.createElement("div");
  div.className=`message ${type}`;
  div.innerHTML=text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  return div;
}

function typingBubble(){
  const div=document.createElement("div");
  div.className="message ai typing";
  div.innerHTML="<span></span><span></span><span></span>";
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  return div;
}

function streamText(el,text){
  el.innerHTML="";
  let i=0;
  const iv=setInterval(()=>{
    el.innerHTML+=text.charAt(i);
    i++;
    if(i>=text.length) clearInterval(iv);
    chat.scrollTop=chat.scrollHeight;
  },20);
}

async function sendMessage(){
  const msg=input.value.trim();
  if(!msg) return;

  addBubble(msg,"user");
  input.value="";

  localStorage.setItem(STORE_KEY, JSON.stringify({
    date:new Date().toISOString().slice(0,10),
    text:msg
  }));

  const typing=typingBubble();

  try{
    const res=await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ message:msg })
    });

    const data=await res.json();
    typing.remove();

    const ai=addBubble("", "ai");
    streamText(ai, data.reply || "…");

  }catch(e){
    typing.remove();
    addBubble("Sunucuya bağlanamadım. Tekrar dener misin?","ai");
  }
}

sendBtn.onclick=sendMessage;

window.onload=()=>{
  const saved=localStorage.getItem(STORE_KEY);
  if(saved){
    const d=JSON.parse(saved);
    const today=new Date().toISOString().slice(0,10);
    const y=new Date(); y.setDate(y.getDate()-1);
    if(d.date===y.toISOString().slice(0,10)){
      addBubble("Dün konuştuğumuz konu ne durumda? İstersen devam edelim.","ai");
    }
  }else{
    addBubble("Hello. I'm here for you.","ai");
  }
};
</script>
</body>
</html>
