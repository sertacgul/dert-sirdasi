<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Soul Confidant</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#111827" />

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="./icon-180.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="./icon-167.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="./icon-152.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="./icon-120.png" />
  <link rel="apple-touch-icon" href="./icon-180.png" />

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+SC:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #f472b6 0%, #a78bfa 100%);
      --user-msg-bg: linear-gradient(135deg, #ec4899, #be185d);
      --btn-bg: #ec4899;
      --icon-bg: linear-gradient(135deg, #f472b6 0%, #a78bfa 100%);
    }
    body.theme-male {
      --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
      --user-msg-bg: linear-gradient(135deg, #2563eb, #1d4ed8);
      --btn-bg: #2563eb;
      --icon-bg: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
    }

    body {
      font-family: 'Nunito', sans-serif;
      background-color: #111827;
      color: #e2e8f0;
      overflow: hidden;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      padding-top: env(safe-area-inset-top);
    }
    .app-container {
      width: 100%;
      height: 100dvh;
      background: linear-gradient(180deg, #1f2937 0%, #0f172a 100%);
      display: flex;
      flex-direction: column;
      position: relative;
      margin: 0 auto;
      max-width: 600px;
    }
    @media (min-width: 768px) {
      .app-container {
        border-left: 1px solid #374151;
        border-right: 1px solid #374151;
      }
    }

    /* Splash */
    .splash-screen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: radial-gradient(circle at center, #1e1b4b 0%, #0f172a 100%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease-out;
    }
    .splash-logo {
      font-size: 4.5rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }
    .splash-title { font-size: 2.2rem; font-weight: 900; color: white; letter-spacing: 1px; }
    .splash-subtitle { color: #94a3b8; font-size: 0.85rem; margin-top: 0.5rem; font-weight: 600; letter-spacing: 1px; }
    .splash-screen.fade-out { opacity: 0; pointer-events: none; }

    /* Modals */
    .modal-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(17, 24, 39, 0.98);
      z-index: 100;
      display: none;
      flex-direction: column;
      justify-content: center;
      padding: 24px;
    }
    .modal-overlay.active { display: flex; }
    .form-select {
      background-color: #1f2937;
      border: 1px solid #374151;
      color: white;
      padding: 12px;
      border-radius: 12px;
      width: 100%;
      margin-bottom: 12px;
      outline: none;
      transition: border-color 0.3s;
      font-size: 0.95rem;
    }
    .form-select:focus { border-color: #ec4899; }
    .lang-select-mini {
      background: #374151;
      color: white;
      border: 1px solid #4b5563;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      outline: none;
    }
    .legal-box {
      background: #111827;
      border: 1px solid #374151;
      padding: 15px;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #cbd5e1;
      margin-bottom: 20px;
      max-height: 250px;
      overflow-y: auto;
      line-height: 1.6;
    }

    /* Chat */
    .chat-area { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 40px; scroll-behavior: smooth; }
    .message-container { display: flex; flex-direction: column; width: 100%; margin-bottom: 16px; animation: popIn 0.3s ease; }
    .message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.5;
      position: relative;
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .message.user { align-self: flex-end; background: var(--user-msg-bg); color: white; border-bottom-right-radius: 2px; }
    .message.ai { align-self: flex-start; background: #334155; color: #f1f5f9; border-bottom-left-radius: 2px; border: 1px solid #475569; }

    /* Feedback */
    .feedback-container { display: flex; gap: 15px; margin-top: 6px; margin-left: 10px; opacity: 0.6; }
    .fb-btn { cursor: pointer; color: #6b7280; font-size: 1rem; transition: 0.2s; }
    .fb-btn:hover { color: white; transform: scale(1.2); }
    .fb-btn.liked { color: #34d399; }
    .fb-btn.disliked { color: #f87171; }

    /* Input */
    .input-area {
      background: #1f2937;
      padding: 16px;
      border-top: 1px solid #374151;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    .send-btn-custom {
      width: 50px; height: 50px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
      transition: 0.2s;
      background-color: var(--btn-bg);
      color: white;
    }
    .send-btn-custom:active { transform: scale(0.95); }

    .mode-switch {
      display: flex;
      background: #111827;
      padding: 4px;
      border-radius: 10px;
      margin-bottom: 5px;
      border: 1px solid #374151;
    }
    .mode-btn {
      flex: 1;
      padding: 8px;
      text-align: center;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      color: #6b7280;
      transition: 0.3s;
      user-select: none;
    }
    .mode-btn.active.advice { background: #374151; color: #f472b6; }
    .mode-btn.active.gossip { background: #4c1d95; color: #e9d5ff; }

    /* Header */
    .header-icon-bg { background: var(--icon-bg); }

    @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .typing-dots span { display: inline-block; width: 6px; height: 6px; background: #cbd5e1; border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* Fonts by lang */
    body.lang-ja { font-family: 'Noto Sans JP', sans-serif; }
    body.lang-zh { font-family: 'Noto Sans SC', sans-serif; }
    body.lang-ar { font-family: 'Noto Sans Arabic', sans-serif; direction: rtl; }

    /* Toast */
    .toast {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom, 0px) + 90px);
      background: rgba(17,24,39,0.92);
      border: 1px solid #374151;
      color: #e5e7eb;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      z-index: 99999;
      display: none;
      max-width: 92%;
      text-align: center;
    }
    .toast.show { display: block; }
  </style>
</head>

<body>
  <div id="mainApp" class="app-container">

    <!-- Splash -->
    <div id="splashScreen" class="splash-screen relative overflow-hidden">
      <canvas id="splashCanvas" class="absolute inset-0"></canvas>
      <div class="relative z-10 text-center px-4">
        <div class="splash-logo"><i class="fa-solid fa-ear-listen"></i></div>
        <h1 class="splash-title">SOUL CONFIDANT</h1>
        <p class="splash-subtitle">Generated with responsibility by ATAOL AI Techs</p>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Legal Modal -->
    <div id="legalModal" class="modal-overlay">
      <div class="w-full max-w-sm mx-auto mb-4 flex justify-end">
        <select id="legalLangSelect" class="lang-select-mini" onchange="app.changeAppLanguage(this.value)">
          <option value="tr">T√ºrk√ße</option>
          <option value="en" selected>English</option>
          <option value="de">Deutsch</option>
          <option value="fr">Fran√ßais</option>
          <option value="es">Espa√±ol</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="ja">Êó•Êú¨Ë™û</option>
          <option value="pt">Portugu√™s</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="zh">‰∏≠Êñá</option>
        </select>
      </div>
      <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 w-full max-w-md mx-auto">
        <h2 id="legalTitle" class="text-xl font-bold text-white mb-4 text-center">Legal Disclaimer</h2>
        <div id="legalTextContent" class="legal-box"></div>
        <button id="legalBtn" onclick="app.acceptLegal()"
          class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl mt-2 transition">
          I Accept
        </button>
      </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay">
      <div class="w-full max-w-sm mx-auto">
        <div class="text-center mb-6">
          <div class="w-16 h-16 rounded-full header-icon-bg flex items-center justify-center text-white text-2xl mx-auto mb-3 shadow-lg transition-colors duration-500">
            <i class="fa-solid fa-user"></i>
          </div>
          <h2 id="profileTitle" class="text-xl font-bold text-white">Let‚Äôs get to know you</h2>
          <p id="profileSubtitle" class="text-gray-400 text-xs mt-1">A safe place to talk.</p>
        </div>
        <form onsubmit="event.preventDefault(); app.submitProfile();">
          <select id="userGender" class="form-select" onchange="app.handleGenderChange(this.value)" required></select>
          <select id="userAge" class="form-select" required></select>
          <select id="userJob" class="form-select" required></select>
          <select id="userRelation" class="form-select" required></select>
          <select id="userMood" class="form-select" required></select>
          <button type="submit" id="startBtn"
            class="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold py-3 rounded-xl mt-4 shadow-lg transform active:scale-95 transition">
            Start <i class="fa-solid fa-arrow-right ml-2"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Header -->
    <header class="p-4 flex items-center justify-between border-b border-gray-700 bg-gray-900 z-10">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full header-icon-bg flex items-center justify-center text-white font-bold text-lg transition-colors duration-500">
          <i class="fa-solid fa-ear-listen"></i>
        </div>
        <div>
          <h1 id="appTitle" class="font-bold text-white">Soul Confidant</h1>
          <span id="appSubtitle" class="text-xs text-pink-400">A safe place to talk</span>
        </div>
      </div>
      <button onclick="app.clearChatHistory()"
        class="w-10 h-10 rounded-full border border-gray-600 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-800 transition">
        <i class="fa-solid fa-trash-can"></i>
      </button>
    </header>

    <!-- Chat -->
    <div id="chatBox" class="chat-area"></div>

    <!-- Input -->
    <div class="input-area">
      <div class="mode-switch">
        <div id="btnAdvice" class="mode-btn active advice" onclick="app.setMode('advice')">
          <i class="fa-solid fa-heart mr-1"></i> <span id="labelAdvice">Vent</span>
        </div>
        <div id="btnGossip" class="mode-btn gossip" onclick="app.setMode('gossip')">
          <i class="fa-solid fa-bolt mr-1"></i> <span id="labelGossip">Gossip</span>
        </div>
      </div>

      <div class="flex gap-2 items-end">
        <textarea id="userInput" rows="2"
          class="w-full bg-gray-800 text-white rounded-xl px-4 py-3 border border-gray-600 focus:border-pink-500 outline-none resize-none text-sm"
          placeholder="Type here..."></textarea>
        <button id="sendBtn" onclick="app.sendMessage()" class="send-btn-custom text-white">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // CONFIG
    // =========================================================
    const BACKEND_URL = "https://dert-sirdasi-api.captsertacgul.workers.dev"; // <-- Endpoint

    // =========================================================
    // Splash Canvas Effect
    // =========================================================
    const CanvasEffect = {
      canvas: null, ctx: null, particles: [], animationId: null,
      init() {
        this.canvas = document.getElementById('splashCanvas');
        if (!this.canvas) return;
        this.ctx = this.canvas.getContext('2d');
        if (!this.ctx) return;
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.createParticles();
        this.animate();
      },
      resize() {
        if (!this.canvas) return;
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
      },
      createParticles() {
        if (!this.canvas) return;
        const count = Math.floor((this.canvas.width * this.canvas.height) / 10000);
        this.particles = [];
        for (let i = 0; i < count; i++) {
          this.particles.push({
            x: Math.random() * this.canvas.width,
            y: Math.random() * this.canvas.height,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5,
            size: Math.random() * 2 + 1,
            alpha: Math.random() * 0.5 + 0.1
          });
        }
      },
      animate() {
        if (!this.ctx) return;
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        for (const p of this.particles) {
          p.x += p.vx; p.y += p.vy;
          if (p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
          if (p.y < 0 || p.y > this.canvas.height) p.vy *= -1;
          this.ctx.fillStyle = `rgba(167, 139, 250, ${p.alpha})`;
          this.ctx.beginPath();
          this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          this.ctx.fill();
        }
        this.animationId = requestAnimationFrame(() => this.animate());
      },
      stop() { if (this.animationId) cancelAnimationFrame(this.animationId); }
    };

    // =========================================================
    // Translations
    // =========================================================
    const Translations = {
      tr: {
        appTitle:"Dert Sƒ±rda≈üƒ±", appSubtitle:"Seninle konu≈ümak iyi gelecek",
        labelAdvice:"Dertle≈üme", labelGossip:"Gƒ±ybet", placeholder:"Yaz bakalƒ±m...",
        legalTitle:"Yasal Uyarƒ±",
        legalText:`<ul>
          <li><strong>1. Ya≈ü Sƒ±nƒ±rƒ±:</strong> 18+ ya≈ü gereklidir.</li>
          <li><strong>2. Sorumluluk Reddi:</strong> Yapay zeka sim√ºlasyonudur.</li>
          <li><strong>3. Etik:</strong> Saygƒ±lƒ± dil kullanƒ±nƒ±z.</li>
          <li><strong>4. Gizlilik:</strong> Veriler cihazƒ±nƒ±zda saklanƒ±r.</li>
          <li><strong>5. Rƒ±za:</strong> Kullanarak ≈üartlarƒ± kabul edersiniz.</li>
        </ul>`,
        legalBtn:"Kabul Ediyorum",
        clearMsg:"Sohbet ge√ßmi≈üi silinsin mi?",
        intro:"Merhaba, seni dinliyorum.",
        followup:"D√ºn konu≈ütuƒüumuz konu ne durumda? ƒ∞stersen kaldƒ±ƒüƒ±mƒ±z yerden devam edelim.",
        profileTitle:"Seni Tanƒ±yalƒ±m", profileSubtitle:"Yargƒ±sƒ±z, g√ºvenli dert ortaƒüƒ±n.", startBtn:"Ba≈üla",
        gender:["Cinsiyet", "Kadƒ±n", "Erkek", "Belirtme"],
        age:["Ya≈ü","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["Meslek", "√ñƒürenci", "√áalƒ±≈üan", "Ev Hanƒ±mƒ±", "ƒ∞≈üsiz", "Emekli"],
        relation:["ƒ∞li≈üki", "Bekar", "ƒ∞li≈ükisi Var", "Evli", "Karma≈üƒ±k"],
        mood:["Ruh halin nasƒ±l?", "Mutlu", "√úzg√ºn", "Kƒ±zgƒ±n", "Yorgun", "N√∂tr"],
        netErr:"Sunucuya baƒülanamadƒ±m. Tekrar dener misin?",
        limitErr:"G√ºnl√ºk √ºcretsiz mesaj hakkƒ±n doldu. Yarƒ±n tekrar buradayƒ±m ü´∂"
      },
      en: {
        appTitle:"Soul Confidant", appSubtitle:"A safe place to talk",
        labelAdvice:"Vent", labelGossip:"Gossip", placeholder:"Type here...",
        legalTitle:"Legal Disclaimer",
        legalText:`<ul>
          <li><strong>1. Age Limit:</strong> 18+ required.</li>
          <li><strong>2. Disclaimer:</strong> AI simulation.</li>
          <li><strong>3. Ethics:</strong> Respectful language only.</li>
          <li><strong>4. Privacy:</strong> Local data storage.</li>
          <li><strong>5. Consent:</strong> By using, you accept terms.</li>
        </ul>`,
        legalBtn:"I Accept",
        clearMsg:"Clear chat history?",
        intro:"Hello. I'm here for you. Tell me what's on your mind.",
        followup:"How did things go with what you shared yesterday? Want to continue from there?",
        profileTitle:"Let‚Äôs get to know you", profileSubtitle:"A safe place to talk.", startBtn:"Start",
        gender:["Gender", "Female", "Male", "Prefer not to say"],
        age:["Age","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["Job", "Student", "Worker", "Homemaker", "Unemployed", "Retired"],
        relation:["Relationship", "Single", "In a relationship", "Married", "Complicated"],
        mood:["Mood", "Happy", "Sad", "Angry", "Tired", "Neutral"],
        netErr:"I couldn't reach the server. Please try again.",
        limitErr:"You‚Äôve reached today‚Äôs free limit. Come back tomorrow ü´∂"
      }
    };

    // =========================================================
    // Storage + state
    // =========================================================
    const StoreKeys = {
      history: "sc_history_v1",
      profile: "sc_profile_v1",
      followup: "sc_followup_v1" // { lastDateISO, lastTopic }
    };

    // =========================================================
    // Helpers
    // =========================================================
    function todayISO() {
      return new Date().toISOString().slice(0,10);
    }
    function yesterdayISO() {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      return d.toISOString().slice(0,10);
    }
    function safeHTML(s) {
      return (s || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // =========================================================
    // AI Controller (backend)
    // =========================================================
    const AIController = {
      history: [],
      userProfile: {},
      genderMode: "female",

      loadData() {
        try {
          const h = localStorage.getItem(StoreKeys.history);
          if (h) this.history = JSON.parse(h);
          const p = localStorage.getItem(StoreKeys.profile);
          if (p) this.userProfile = JSON.parse(p);
          return !!p;
        } catch (e) { return false; }
      },
      saveHistory() { localStorage.setItem(StoreKeys.history, JSON.stringify(this.history)); },
      saveProfile(p) { localStorage.setItem(StoreKeys.profile, JSON.stringify(p)); this.userProfile = p; },
      clear() {
        this.history = [];
        localStorage.removeItem(StoreKeys.history);
        localStorage.removeItem(StoreKeys.profile);
        localStorage.removeItem(StoreKeys.followup);
      },

      addUserMessage(text) {
        this.history.push({ role: "user", text, ts: Date.now() });
        if (this.history.length > 60) this.history = this.history.slice(-60);
        this.saveHistory();
      },
      addAIMessage(text) {
        this.history.push({ role: "ai", text, ts: Date.now() });
        if (this.history.length > 60) this.history = this.history.slice(-60);
        this.saveHistory();
      },

      updateFollowupTopicFromUserText(userText) {
        try {
          const payload = {
            lastDateISO: todayISO(),
            lastTopic: (userText || "").slice(0, 500)
          };
          localStorage.setItem(StoreKeys.followup, JSON.stringify(payload));
        } catch(e) {}
      },

      async generate(message, mode) {
        const body = {
          message,
          mode,
          lang: (app && app.lang) ? app.lang : "en",
          profile: this.userProfile,
          history: this.history.slice(-10).map(m => ({ role: m.role, text: m.text }))
        };

        // follow-up context'i de backend'e g√∂nderelim (ister g√∂rmezden gelsin)
        try {
          const raw = localStorage.getItem(StoreKeys.followup);
          if (raw) body.followup = JSON.parse(raw);
        } catch(e) {}

        let res;
        try {
          res = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
        } catch (e) {
          return { ok: false, code: 0, reply: (Translations[app.lang] || Translations.en).netErr };
        }

        if (res.status === 429) {
          return { ok: false, code: 429, reply: (Translations[app.lang] || Translations.en).limitErr };
        }

        if (!res.ok) {
          return { ok: false, code: res.status, reply: (Translations[app.lang] || Translations.en).netErr };
        }

        const data = await res.json().catch(() => ({}));
        const reply = data.reply || data.text || data.message || "";
        return { ok: true, code: 200, reply: reply || (Translations[app.lang] || Translations.en).netErr };
      }
    };

    // =========================================================
    // App UI
    // =========================================================
    const app = {
      lang: "en",
      currentMode: "advice",
      sendLock: false,

      init() {
        this.chatBox = document.getElementById("chatBox");
        this.input = document.getElementById("userInput");

        try { CanvasEffect.init(); } catch(e) {}

        this.input.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });

        const hasProfile = AIController.loadData();

        if (AIController.userProfile && AIController.userProfile.language) {
          this.lang = AIController.userProfile.language;
          const sel = document.getElementById("legalLangSelect");
          if (sel) sel.value = this.lang;
        } else {
          const sel = document.getElementById("legalLangSelect");
          if (sel) this.lang = sel.value || "en";
        }

        this.updateLang(this.lang);

        setTimeout(() => {
          const sp = document.getElementById("splashScreen");
          if (sp) {
            sp.classList.add("fade-out");
            setTimeout(() => sp.style.display = "none", 600);
          }
          const legal = document.getElementById("legalModal");
          if (legal) legal.classList.add("active");

          // theme restore
          if (AIController.userProfile && AIController.userProfile.gender) {
            this.updateTheme(AIController.userProfile.gender);
          }

        }, 1200);
      },

      toast(msg, ms=2200) {
        const t = document.getElementById("toast");
        if (!t) return;
        t.innerText = msg;
        t.classList.add("show");
        clearTimeout(this._toastTimer);
        this._toastTimer = setTimeout(() => t.classList.remove("show"), ms);
      },

      changeAppLanguage(val) { this.lang = val; this.updateLang(val); },

      updateLang(l) {
        const t = Translations[l] || Translations.en;

        const setT = (id, v) => { const el = document.getElementById(id); if (el) el.innerText = v || ""; };
        const setH = (id, v) => { const el = document.getElementById(id); if (el) el.innerHTML = v || ""; };

        setT("legalTitle", t.legalTitle);
        setH("legalTextContent", t.legalText);
        setT("legalBtn", t.legalBtn);

        setT("profileTitle", t.profileTitle);
        setT("profileSubtitle", t.profileSubtitle);

        setT("appTitle", t.appTitle);
        setT("appSubtitle", t.appSubtitle);
        setT("labelAdvice", t.labelAdvice);
        setT("labelGossip", t.labelGossip);

        const inp = document.getElementById("userInput");
        if (inp) inp.placeholder = t.placeholder;

        this.fillSelect("userGender", t.gender);
        this.fillSelect("userAge", t.age);
        this.fillSelect("userJob", t.job);
        this.fillSelect("userRelation", t.relation);
        this.fillSelect("userMood", t.mood);

        document.body.classList.remove("lang-ar", "lang-ja", "lang-zh");
        if (l === "ar") document.body.classList.add("lang-ar");
        if (l === "ja") document.body.classList.add("lang-ja");
        if (l === "zh") document.body.classList.add("lang-zh");
      },

      fillSelect(id, opts) {
        const sel = document.getElementById(id);
        if (!sel || !Array.isArray(opts)) return;
        const prev = sel.value;
        sel.innerHTML = "";
        opts.forEach((o, i) => {
          const op = document.createElement("option");
          op.value = o;
          op.innerText = o;
          if (i === 0) { op.disabled = true; op.selected = true; }
          sel.add(op);
        });
        if (prev && opts.includes(prev)) sel.value = prev;
      },

      acceptLegal() {
        const sel = document.getElementById("legalLangSelect");
        if (sel) this.lang = sel.value;

        const legal = document.getElementById("legalModal");
        if (legal) legal.classList.remove("active");

        // profile var mƒ±?
        if (AIController.userProfile && AIController.userProfile.age) {
          AIController.userProfile.language = this.lang;
          AIController.saveProfile(AIController.userProfile);
          this.updateLang(this.lang);

          if (AIController.history.length > 0) this.restoreChat();
          else {
            const t = Translations[this.lang] || Translations.en;
            setTimeout(() => this.addBubble(t.intro, "ai"), 400);
          }

          setTimeout(() => this.maybeAskYesterdayFollowup(), 700);
        } else {
          this.updateLang(this.lang);
          const pm = document.getElementById("profileModal");
          if (pm) pm.classList.add("active");
        }
      },

      handleGenderChange(val) {
        this.updateTheme(val);

        const t = Translations[this.lang] || Translations.en;
        this.fillSelect("userJob", t.job);

        const isMale = (val || "").toLowerCase().includes("erkek") || (val || "").toLowerCase().includes("male");
        if (isMale) {
          const jobSel = document.getElementById("userJob");
          if (!jobSel) return;
          for (let i = 0; i < jobSel.options.length; i++) {
            const txt = jobSel.options[i].value || "";
            if (txt.includes("Hanƒ±m") || txt.includes("Homemaker") || txt.includes("Hausfrau")) {
              jobSel.remove(i); i--;
            }
          }
        }
      },

      updateTheme(val) {
        const v = (val || "").toLowerCase();
        const isMale = v.includes("erkek") || v.includes("male");
        if (isMale) {
          document.body.classList.add("theme-male");
          AIController.genderMode = "male";
        } else {
          document.body.classList.remove("theme-male");
          AIController.genderMode = (v.includes("kadƒ±n") || v.includes("female")) ? "female" : "neutral";
        }
      },

      submitProfile() {
        const g = document.getElementById("userGender").value;
        const a = document.getElementById("userAge").value;

        if (document.getElementById("userAge").selectedIndex === 0) { alert("Select"); return; }

        const p = {
          gender: g, age: a, language: this.lang,
          job: document.getElementById("userJob").value,
          relation: document.getElementById("userRelation").value,
          mood: document.getElementById("userMood").value
        };

        AIController.saveProfile(p);
        this.updateTheme(g);

        const pm = document.getElementById("profileModal");
        if (pm) pm.classList.remove("active");

        setTimeout(() => {
          const t = Translations[this.lang] || Translations.en;
          let txt = t.intro;
          const ml = (p.mood || "").toLowerCase();
          if (ml.includes("√ºzg√ºn") || ml.includes("sad")) txt += " üòî";
          else if (ml.includes("mutlu") || ml.includes("happy")) txt += " üòÉ";
          else if (ml.includes("kƒ±zgƒ±n") || ml.includes("angry")) txt += " üò°";
          this.addBubble(txt, "ai");
          setTimeout(() => this.maybeAskYesterdayFollowup(), 600);
        }, 450);
      },

      clearChatHistory() {
        const t = Translations[this.lang] || Translations.en;
        if (confirm(t.clearMsg)) {
          AIController.clear();
          this.chatBox.innerHTML = "";
          location.reload();
        }
      },

      restoreChat() {
        this.chatBox.innerHTML = "";
        for (const m of AIController.history) {
          if (!m || !m.text) continue;
          const type = (m.role === "user") ? "user" : "ai";
          this.addBubble(m.text, type, true);
        }
        setTimeout(() => this.scrollToBottom(), 100);
      },

      setMode(m) {
        this.currentMode = m;
        document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
        const btn = document.getElementById(m === "advice" ? "btnAdvice" : "btnGossip");
        if (btn) btn.classList.add("active");
      },

      addBubble(txt, type, noAnim=false) {
        const box = this.chatBox;

        const wrap = document.createElement("div");
        wrap.className = "message-container";

        const bubble = document.createElement("div");
        bubble.className = `message ${type}`;
        if (noAnim) bubble.style.animation = "none";
        bubble.innerHTML = (txt || "").replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");

        wrap.appendChild(bubble);

        if (type === "ai" && !noAnim) {
          const fb = document.createElement("div");
          fb.className = "feedback-container";
          fb.innerHTML = `
            <i class="fa-regular fa-thumbs-up fb-btn" onclick="this.classList.toggle('liked')"></i>
            <i class="fa-regular fa-thumbs-down fb-btn" onclick="this.classList.toggle('disliked')"></i>
          `;
          wrap.appendChild(fb);
        }

        box.appendChild(wrap);
        this.scrollToBottom();
        return bubble; // <- streaming i√ßin
      },

      showTyping(id) {
        const box = this.chatBox;
        const d = document.createElement("div");
        d.id = id;
        d.className = "message ai opacity-50";
        d.style.width = "60px";
        d.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
        box.appendChild(d);
        this.scrollToBottom();
      },

      scrollToBottom() {
        const b = this.chatBox;
        b.scrollTop = b.scrollHeight;
      },

      // 1Ô∏è‚É£ D√ºn follow-up
      maybeAskYesterdayFollowup() {
        try {
          const raw = localStorage.getItem(StoreKeys.followup);
          if (!raw) return;
          const data = JSON.parse(raw);
          if (!data || !data.lastDateISO || !data.lastTopic) return;

          if (data.lastDateISO === yesterdayISO()) {
            const t = Translations[this.lang] || Translations.en;
            this.addBubble(t.followup, "ai");
          }
        } catch(e) {}
      },

      // 2Ô∏è‚É£ Streaming hissi: cevap geldikten sonra harf harf yaz
      async typeWriterIntoBubble(bubbleEl, fullText, speedMs=14) {
        const raw = fullText || "";
        // **bold** d√∂n√º≈ü√ºm√º i√ßin sonradan uygulayacaƒüƒ±z; √∂nce d√ºz metin akƒ±tƒ±yoruz
        bubbleEl.innerHTML = "";
        let i = 0;
        while (i < raw.length) {
          bubbleEl.innerText = raw.slice(0, i + 1);
          i++;
          await new Promise(r => setTimeout(r, speedMs));
          this.scrollToBottom();
        }
        // final format
        bubbleEl.innerHTML = safeHTML(raw).replace(/\*\*(.*?)\*\*/g, "<b>$1</b>").replace(/\n/g, "<br/>");
      },

      async sendMessage() {
        if (this.sendLock) return;

        const txt = (this.input.value || "").trim();
        if (!txt) return;

        this.sendLock = true;

        // UI + local
        this.addBubble(txt, "user");
        this.input.value = "";
        AIController.addUserMessage(txt);
        AIController.updateFollowupTopicFromUserText(txt);

        const tid = "t-" + Date.now();
        this.showTyping(tid);

        // backend
        let result;
        try {
          result = await AIController.generate(txt, this.currentMode);
        } catch (e) {
          result = { ok: false, code: 0, reply: (Translations[this.lang] || Translations.en).netErr };
        }

        const te = document.getElementById(tid);
        if (te) te.remove();

        if (!result.ok) {
          this.toast(result.reply);
          this.addBubble(result.reply, "ai");
          AIController.addAIMessage(result.reply);
          this.sendLock = false;
          return;
        }

        // AI bubble + streaming
        const aiBubbleEl = this.addBubble("", "ai"); // bo≈ü balon a√ß
        await this.typeWriterIntoBubble(aiBubbleEl, result.reply, 14);

        AIController.addAIMessage(result.reply);
        this.sendLock = false;
      }
    };

    window.addEventListener("load", () => app.init());
  </script>
</body>
</html>
