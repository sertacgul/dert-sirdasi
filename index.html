<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Soul Confidant</title>

  <!-- PWA & Mobile Settings -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111827">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="./icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="./icon-167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="./icon-152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="./icon-120.png">
  <link rel="apple-touch-icon" href="./icon-180.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+SC:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #f472b6 0%, #a78bfa 100%);
      --user-msg-bg: linear-gradient(135deg, #ec4899, #be185d);
      --btn-bg: #ec4899;
      --icon-bg: linear-gradient(135deg, #f472b6 0%, #a78bfa 100%);
    }
    body.theme-male {
      --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
      --user-msg-bg: linear-gradient(135deg, #2563eb, #1d4ed8);
      --btn-bg: #2563eb;
      --icon-bg: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
    }

    body {
      font-family: 'Nunito', sans-serif;
      background-color: #111827;
      color: #e2e8f0;
      overflow: hidden;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      padding-top: env(safe-area-inset-top);
    }
    .app-container {
      width: 100%;
      height: 100dvh;
      background: linear-gradient(180deg, #1f2937 0%, #0f172a 100%);
      display: flex;
      flex-direction: column;
      position: relative;
      margin: 0 auto;
      max-width: 600px;
    }
    @media (min-width: 768px) {
      .app-container { border-left: 1px solid #374151; border-right: 1px solid #374151; }
    }

    /* Splash */
    .splash-screen {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: radial-gradient(circle at center, #1e1b4b 0%, #0f172a 100%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease-out;
    }
    .splash-logo {
      font-size: 4.5rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }
    .splash-title { font-size: 2.5rem; font-weight: 900; color: white; }
    .splash-subtitle { color: #94a3b8; font-size: 0.9rem; margin-top: 0.5rem; font-weight: 600; letter-spacing: 1px; }
    .splash-screen.fade-out { opacity: 0; pointer-events: none; }

    /* Modals */
    .modal-overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(17, 24, 39, 0.98);
      z-index: 100;
      display: none;
      flex-direction: column;
      justify-content: center;
      padding: 24px;
    }
    .modal-overlay.active { display: flex; }
    .form-select {
      background-color: #1f2937;
      border: 1px solid #374151;
      color: white;
      padding: 12px;
      border-radius: 12px;
      width: 100%;
      margin-bottom: 12px;
      outline: none;
      transition: border-color 0.3s;
      font-size: 0.95rem;
    }
    .form-select:focus { border-color: #ec4899; }
    .lang-select-mini {
      background: #374151;
      color: white;
      border: 1px solid #4b5563;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      outline: none;
    }
    .legal-box {
      background: #111827;
      border: 1px solid #374151;
      padding: 15px;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #cbd5e1;
      margin-bottom: 20px;
      max-height: 250px;
      overflow-y: auto;
      line-height: 1.6;
    }

    /* Chat */
    .chat-area { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 40px; scroll-behavior: smooth; }
    .message-container { display: flex; flex-direction: column; width: 100%; margin-bottom: 16px; animation: popIn 0.3s ease; }
    .message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.5;
      position: relative;
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .message.user { align-self: flex-end; background: var(--user-msg-bg); color: white; border-bottom-right-radius: 2px; }
    .message.ai { align-self: flex-start; background: #334155; color: #f1f5f9; border-bottom-left-radius: 2px; border: 1px solid #475569; }

    /* Feedback */
    .feedback-container { display: flex; gap: 15px; margin-top: 6px; margin-left: 10px; opacity: 0.6; }
    .fb-btn { cursor: pointer; color: #6b7280; font-size: 1rem; transition: 0.2s; }
    .fb-btn:hover { color: white; transform: scale(1.2); }
    .fb-btn.liked { color: #34d399; }
    .fb-btn.disliked { color: #f87171; }

    /* Input */
    .input-area {
      background: #1f2937;
      padding: 16px;
      border-top: 1px solid #374151;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    .send-btn-custom {
      width: 50px; height: 50px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
      transition: 0.2s;
      background-color: var(--btn-bg);
      color: white;
    }
    .send-btn-custom:active { transform: scale(0.95); }

    .mode-switch { display: flex; background: #111827; padding: 4px; border-radius: 10px; margin-bottom: 5px; border: 1px solid #374151; }
    .mode-btn {
      flex: 1; padding: 8px; text-align: center;
      border-radius: 8px; font-size: 0.8rem; font-weight: 700;
      cursor: pointer; color: #6b7280; transition: 0.3s;
      user-select: none;
    }
    .mode-btn.active.advice { background: #374151; color: #f472b6; }
    .mode-btn.active.gossip { background: #4c1d95; color: #e9d5ff; }

    /* Dynamic Header */
    .header-icon-bg { background: var(--icon-bg); }

    @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .typing-dots span { display: inline-block; width: 6px; height: 6px; background: #cbd5e1; border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* Fonts */
    body.lang-ja { font-family: 'Noto Sans JP', sans-serif; }
    body.lang-zh { font-family: 'Noto Sans SC', sans-serif; }
    body.lang-ar { font-family: 'Noto Sans Arabic', sans-serif; direction: rtl; }
  </style>
</head>

<body>
  <div id="mainApp" class="app-container">
    <!-- SPLASH -->
    <div id="splashScreen" class="splash-screen relative overflow-hidden">
      <canvas id="splashCanvas" class="absolute inset-0"></canvas>
      <div class="relative z-10">
        <div class="splash-logo"><i class="fa-solid fa-ear-listen"></i></div>
        <h1 class="splash-title">DERT SIRDAÅI</h1>
        <p class="splash-subtitle">Generated with responsibility by ATAOL AI Techs</p>
      </div>
    </div>

    <!-- LEGAL MODAL -->
    <div id="legalModal" class="modal-overlay">
      <div class="w-full max-w-sm mx-auto mb-4 flex justify-end">
        <select id="legalLangSelect" class="lang-select-mini" onchange="app.changeAppLanguage(this.value)">
          <option value="tr" selected>TÃ¼rkÃ§e</option>
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="fr">FranÃ§ais</option>
          <option value="es">EspaÃ±ol</option>
          <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="pt">PortuguÃªs</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="zh">ä¸­æ–‡</option>
        </select>
      </div>
      <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 w-full max-w-md mx-auto">
        <h2 id="legalTitle" class="text-xl font-bold text-white mb-4 text-center">Yasal UyarÄ±</h2>
        <div id="legalTextContent" class="legal-box"></div>
        <button id="legalBtn" onclick="app.acceptLegal()"
          class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl mt-2 transition">
          Kabul Ediyorum
        </button>
      </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profileModal" class="modal-overlay">
      <div class="w-full max-w-sm mx-auto">
        <div class="text-center mb-6">
          <div class="w-16 h-16 rounded-full header-icon-bg flex items-center justify-center text-white text-2xl mx-auto mb-3 shadow-lg transition-colors duration-500">
            <i class="fa-solid fa-user"></i>
          </div>
          <h2 id="profileTitle" class="text-xl font-bold text-white">Seni TanÄ±yalÄ±m</h2>
          <p id="profileSubtitle" class="text-gray-400 text-xs mt-1">YargÄ±sÄ±z, gÃ¼venli dert ortaÄŸÄ±n.</p>
        </div>
        <form onsubmit="event.preventDefault(); app.submitProfile();">
          <select id="userGender" class="form-select" onchange="app.handleGenderChange(this.value)" required></select>
          <select id="userAge" class="form-select" required></select>
          <select id="userJob" class="form-select" required></select>
          <select id="userRelation" class="form-select" required></select>
          <select id="userMood" class="form-select" required></select>
          <button type="submit" id="startBtn"
            class="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold py-3 rounded-xl mt-4 shadow-lg transform active:scale-95 transition">
            BaÅŸla
          </button>
        </form>
      </div>
    </div>

    <!-- APP HEADER -->
    <header class="p-4 flex items-center justify-between border-b border-gray-700 bg-gray-900 z-10">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full header-icon-bg flex items-center justify-center text-white font-bold text-lg transition-colors duration-500">
          <i class="fa-solid fa-ear-listen"></i>
        </div>
        <div>
          <h1 id="appTitle" class="font-bold text-white">Soul Confidant</h1>
          <span id="appSubtitle" class="text-xs text-pink-400">Seninle konuÅŸmak iyi gelecek</span>
        </div>
      </div>
      <button onclick="app.clearChatHistory()"
        class="w-10 h-10 rounded-full border border-gray-600 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-800 transition">
        <i class="fa-solid fa-trash-can"></i>
      </button>
    </header>

    <!-- CHAT AREA -->
    <div id="chatBox" class="chat-area"></div>

    <!-- INPUT AREA -->
    <div class="input-area">
      <div class="mode-switch">
        <div id="btnAdvice" class="mode-btn active advice" onclick="app.setMode('advice')">
          <i class="fa-solid fa-heart mr-1"></i> <span id="labelAdvice">DertleÅŸme</span>
        </div>
        <div id="btnGossip" class="mode-btn gossip" onclick="app.setMode('gossip')">
          <i class="fa-solid fa-bolt mr-1"></i> <span id="labelGossip">GÄ±ybet</span>
        </div>
      </div>

      <div class="flex gap-2 items-end">
        <textarea id="userInput" rows="2"
          class="w-full bg-gray-800 text-white rounded-xl px-4 py-3 border border-gray-600 focus:border-pink-500 outline-none resize-none text-sm"
          placeholder="Yaz bakalÄ±m..."></textarea>
        <button id="sendBtn" onclick="app.sendMessage()" class="send-btn-custom text-white">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // =================================================================
    // 1) API KEY CONFIGURATION (SENÄ°N KODUN - DEÄÄ°ÅTÄ°RME)
    // =================================================================
    const partA = "AIzaSyDZQttGiJrIPow";
    const partB = "g9y4sBCXx_yYBmNQM0m8";
    const apiKey = partA + partB;

    // =================================================================
    // 2) VISUAL CANVAS EFFECT (SENÄ°N KODUN)
    // =================================================================
    const CanvasEffect = {
      canvas: null, ctx: null, particles: [], animationId: null,
      init() {
        this.canvas = document.getElementById('splashCanvas');
        if (!this.canvas) return;
        this.ctx = this.canvas.getContext('2d');
        if (!this.ctx) return;
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.createParticles();
        this.animate();
      },
      resize() {
        if (this.canvas) { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; }
      },
      createParticles() {
        if (!this.canvas) return;
        const count = Math.floor((this.canvas.width * this.canvas.height) / 10000);
        this.particles = [];
        for (let i = 0; i < count; i++) {
          this.particles.push({
            x: Math.random() * this.canvas.width, y: Math.random() * this.canvas.height,
            vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5,
            size: Math.random() * 2 + 1, alpha: Math.random() * 0.5 + 0.1
          });
        }
      },
      animate() {
        if (!this.ctx) return;
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        for (let i = 0; i < this.particles.length; i++) {
          const p = this.particles[i]; p.x += p.vx; p.y += p.vy;
          if (p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
          if (p.y < 0 || p.y > this.canvas.height) p.vy *= -1;
          this.ctx.fillStyle = `rgba(167, 139, 250, ${p.alpha})`;
          this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); this.ctx.fill();
        }
        this.animationId = requestAnimationFrame(() => this.animate());
      },
      stop() { if (this.animationId) cancelAnimationFrame(this.animationId); }
    };

    // =================================================================
    // 3) TRANSLATIONS (SENÄ°N KODUN + FOLLOWUP EKÄ°)
    // =================================================================
    const Translations = {
      tr: {
        appTitle: "Soul Confidant", appSubtitle: "Seninle konuÅŸmak iyi gelecek", labelAdvice: "DertleÅŸme", labelGossip: "GÄ±ybet", placeholder: "Yaz bakalÄ±m...",
        legalTitle: "Yasal UyarÄ±",
        legalText: "<ul><li><strong>1. YaÅŸ SÄ±nÄ±rÄ±:</strong> 18+ yaÅŸ gereklidir.</li><li><strong>2. Sorumluluk Reddi:</strong> Yapay zeka simÃ¼lasyonudur.</li><li><strong>3. Etik:</strong> SaygÄ±lÄ± dil kullanÄ±nÄ±z.</li><li><strong>4. Gizlilik:</strong> Veriler cihazÄ±nÄ±zda saklanÄ±r.</li><li><strong>5. RÄ±za:</strong> Kullanarak ÅŸartlarÄ± kabul edersiniz.</li></ul>",
        legalBtn: "Kabul Ediyorum", clearMsg: "Sohbet geÃ§miÅŸi silinsin mi?", intro: "Merhaba, seni dinliyorum.",
        followup: "DÃ¼n konuÅŸtuÄŸumuz konu ne durumda? Ä°stersen kaldÄ±ÄŸÄ±mÄ±z yerden devam edelim.",
        profileTitle: "Seni TanÄ±yalÄ±m", profileSubtitle: "YargÄ±sÄ±z, gÃ¼venli dert ortaÄŸÄ±n.", startBtn: "BaÅŸla",
        gender: ["Cinsiyet", "KadÄ±n", "Erkek", "Belirtme"],
        age: ["YaÅŸ", "18-24", "25-34", "35-44", "45-54", "55-64", "65-75", "75+"],
        job: ["Meslek", "Ã–ÄŸrenci", "Ã‡alÄ±ÅŸan", "Ev HanÄ±mÄ±", "Ä°ÅŸsiz", "Emekli"],
        relation: ["Ä°liÅŸki", "Bekar", "Ä°liÅŸkisi Var", "Evli", "KarmaÅŸÄ±k"],
        mood: ["Ruh halin nasÄ±l?", "Mutlu", "ÃœzgÃ¼n", "KÄ±zgÄ±n", "Yorgun", "NÃ¶tr"]
      },
      en: {
        appTitle: "Soul Confidant", appSubtitle: "Good to talk", labelAdvice: "Vent", labelGossip: "Gossip", placeholder: "Type here...",
        legalTitle: "Legal Disclaimer",
        legalText: "<ul><li><strong>1. Age Limit:</strong> 18+ required.</li><li><strong>2. Disclaimer:</strong> AI simulation.</li><li><strong>3. Ethics:</strong> Respectful language only.</li><li><strong>4. Privacy:</strong> Local data storage.</li><li><strong>5. Consent:</strong> By using, you accept terms.</li></ul>",
        legalBtn: "I Accept", clearMsg: "Clear history?", intro: "Hello, I'm listening.",
        followup: "How did things go with what you shared yesterday? Want to continue from there?",
        profileTitle: "Let's Know You", profileSubtitle: "Safe space.", startBtn: "Start",
        gender: ["Gender", "Female", "Male", "N/A"],
        age: ["Age", "18-24", "25-34", "35-44", "45-54", "55-64", "65-75", "75+"],
        job: ["Job?", "Student", "Worker", "Homemaker", "Unemployed", "Retired"],
        relation: ["Status?", "Single", "Taken", "Married", "Complicated"],
        mood: ["Mood?", "Happy", "Sad", "Angry", "Tired", "Neutral"]
      },
      de: { appTitle:"Seelenverwandter", appSubtitle:"Es tut gut zu reden", labelAdvice:"Reden", labelGossip:"Klatsch", placeholder:"Schreiben...", legalTitle:"Rechtlicher Hinweis",
        legalText:"<ul><li><strong>1. Altersgrenze:</strong> Teilnahme ab 18 Jahren.</li><li><strong>2. Haftungsausschluss:</strong> KI-Simulation.</li><li><strong>3. Ethik:</strong> Respektvolle Sprache.</li><li><strong>4. Sicherheit:</strong> Daten lokal.</li><li><strong>5. Zustimmung:</strong> Nutzung = Zustimmung.</li></ul>",
        legalBtn:"Ich stimme zu", clearMsg:"Soll der Chatverlauf gelÃ¶scht werden?", intro:"Hallo, ich hÃ¶re zu.",
        followup:"Wie ist es mit dem Thema von gestern gelaufen?", profileTitle:"Dich Kennenlernen", profileSubtitle:"Sicherer Raum.", startBtn:"Starten",
        gender:["Geschlecht","Weiblich","MÃ¤nnlich","k.A."], age:["Alter","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["Beruf?","Student","Arbeit","Hausfrau","Arbeitslos","Rentner"], relation:["Status?","Single","Beziehung","Verheiratet","Kompliziert"], mood:["Laune?","Gut","Schlecht","WÃ¼tend","MÃ¼de","Neutral"]
      },
      fr: { appTitle:"Confident", appSubtitle:"Parler fait du bien", labelAdvice:"Confier", labelGossip:"Potins", placeholder:"Ã‰crivez...", legalTitle:"Avis LÃ©gal",
        legalText:"<ul><li><strong>1. Limite d'Ã¢ge:</strong> 18+.</li><li><strong>2. Clause:</strong> Simulation IA.</li><li><strong>3. Ã‰thique:</strong> Langage respectueux.</li><li><strong>4. ConfidentialitÃ©:</strong> DonnÃ©es locales.</li><li><strong>5. Consentement:</strong> Usage = accord.</li></ul>",
        legalBtn:"Je suis d'accord", clearMsg:"Faut-il supprimer l'historique des conversations ?", intro:"Bonjour, je vous Ã©coute.",
        followup:"Et le sujet dâ€™hier, Ã§a va mieux ?", profileTitle:"Faisons Connaissance", profileSubtitle:"Espace sÃ»r.", startBtn:"Commencer",
        gender:["Genre","Femme","Homme","N/A"], age:["Ã‚ge","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["Emploi?","Ã‰tudiant","Travail","Au foyer","Sans emploi","RetraitÃ©"], relation:["Statut?","CÃ©libataire","En couple","MariÃ©","CompliquÃ©"], mood:["Humeur?","Bien","Mal","FÃ¢chÃ©","FatiguÃ©","Neutre"]
      },
      es: { appTitle:"Confidente", appSubtitle:"Hablar te harÃ¡ bien", labelAdvice:"Desahogarse", labelGossip:"Chisme", placeholder:"Escribe...", legalTitle:"Aviso Legal",
        legalText:"<ul><li><strong>1. Edad:</strong> 18+.</li><li><strong>2. Aviso:</strong> SimulaciÃ³n IA.</li><li><strong>3. Ã‰tica:</strong> Lenguaje respetuoso.</li><li><strong>4. Privacidad:</strong> Datos locales.</li><li><strong>5. Consentimiento:</strong> Uso = aceptaciÃ³n.</li></ul>",
        legalBtn:"Aceptar", clearMsg:"Â¿Borrar?", intro:"Hola.",
        followup:"Â¿QuÃ© tal lo de ayer?", profileTitle:"ConozcÃ¡monos", profileSubtitle:"Espacio seguro.", startBtn:"Iniciar",
        gender:["GÃ©nero?","Mujer","Hombre","N/A"], age:["Edad","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["OcupaciÃ³n?","Estudiante","Trabajo","Ama de casa","Desempleado","Jubilado"], relation:["Estado?","Soltero","En pareja","Casado","Complicado"], mood:["Ãnimo?","Bien","Mal","Enojado","Cansado","Neutral"]
      },
      ru: { appTitle:"Ğ”ÑƒÑˆĞµĞ²Ğ½Ñ‹Ğ¹ Ğ”Ñ€ÑƒĞ³", appSubtitle:"Ğ Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ¿Ğ¾Ğ¼Ğ¾Ğ¶ĞµÑ‚", labelAdvice:"Ğ’Ñ‹Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒÑÑ", labelGossip:"Ğ¡Ğ¿Ğ»ĞµÑ‚Ğ½Ğ¸", placeholder:"ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ...", legalTitle:"Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ",
        legalText:"<ul><li><strong>1. Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚:</strong> 18+.</li><li><strong>2. Ğ”Ğ¸ÑĞºĞ»ĞµĞ¹Ğ¼ĞµÑ€:</strong> Ğ˜Ğ˜-ÑĞ¸Ğ¼ÑƒĞ»ÑÑ†Ğ¸Ñ.</li><li><strong>3. Ğ­Ñ‚Ğ¸ĞºĞ°:</strong> Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ·Ñ‹Ğº.</li><li><strong>4. ĞŸÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ:</strong> Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾.</li><li><strong>5. Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ:</strong> Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ = ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ.</li></ul>",
        legalBtn:"ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ", clearMsg:"ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ?", intro:"Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ.",
        followup:"ĞšĞ°Ğº Ğ´ĞµĞ»Ğ° Ñ Ñ‚ĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ²Ñ‡ĞµÑ€Ğ°?", profileTitle:"ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", profileSubtitle:"Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾.", startBtn:"ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ",
        gender:["ĞŸĞ¾Ğ»?","Ğ–ĞµĞ½ÑĞºĞ¸Ğ¹","ĞœÑƒĞ¶ÑĞºĞ¾Ğ¹","N/A"], age:["Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°?","Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚","Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ","Ğ”Ğ¾Ğ¼Ğ¾Ñ…Ğ¾Ğ·ÑĞ¹ĞºĞ°","Ğ‘ĞµĞ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ½Ñ‹Ğ¹","ĞŸĞµĞ½ÑĞ¸Ğ¾Ğ½ĞµÑ€"], relation:["Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ?","Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´ĞµĞ½","Ğ’ Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸ÑÑ…","Ğ–ĞµĞ½Ğ°Ñ‚/Ğ—Ğ°Ğ¼ÑƒĞ¶ĞµĞ¼","Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾"], mood:["ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ?","Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾","ĞŸĞ»Ğ¾Ñ…Ğ¾","Ğ—Ğ»ÑÑÑŒ","Ğ£ÑÑ‚Ğ°Ğ»","ĞĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾"]
      },
      ja: { appTitle:"å¿ƒã®å‹", appSubtitle:"è©±ã™ã“ã¨ã§æ¥½ã«", labelAdvice:"ç›¸è«‡", labelGossip:"å™‚è©±", placeholder:"å…¥åŠ›...", legalTitle:"å…è²¬äº‹é …",
        legalText:"<ul><li><strong>1. å¹´é½¢:</strong> 18+.</li><li><strong>2. å…è²¬:</strong> AIã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³.</li><li><strong>3. å€«ç†:</strong> ä¸å¯§ãªè¨€è‘‰.</li><li><strong>4. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼:</strong> ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜.</li><li><strong>5. åŒæ„:</strong> åˆ©ç”¨=åŒæ„.</li></ul>",
        legalBtn:"åŒæ„", clearMsg:"å±¥æ­´å‰Šé™¤ï¼Ÿ", intro:"ã“ã‚“ã«ã¡ã¯ã€‚",
        followup:"æ˜¨æ—¥ã®ã“ã¨ã€ãã®å¾Œã©ã†ï¼Ÿ", profileTitle:"ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«", profileSubtitle:"å®‰å…¨ãªå ´æ‰€ã€‚", startBtn:"é–‹å§‹",
        gender:["æ€§åˆ¥?","å¥³æ€§","ç”·æ€§","æœªå›ç­”"], age:["å¹´é½¢","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["è·æ¥­?","å­¦ç”Ÿ","ä¼šç¤¾å“¡","ä¸»å©¦","ç„¡è·","é€€è·"], relation:["ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹?","ç‹¬èº«","äº¤éš›ä¸­","æ—¢å©š","è¤‡é›‘"], mood:["æ°—åˆ†?","è‰¯ã„","æ‚ªã„","æ€’ã‚Š","ç–²ã‚Œ","æ™®é€š"]
      },
      pt: { appTitle:"Confidente", appSubtitle:"Falar faz bem", labelAdvice:"Desabafar", labelGossip:"Fofoca", placeholder:"Digite...", legalTitle:"Aviso",
        legalText:"<ul><li><strong>1. Idade:</strong> 18+.</li><li><strong>2. Aviso:</strong> SimulaÃ§Ã£o IA.</li><li><strong>3. Ã‰tica:</strong> Linguagem respeitosa.</li><li><strong>4. Privacidade:</strong> Dados locais.</li><li><strong>5. Consentimento:</strong> Uso=aceite.</li></ul>",
        legalBtn:"Aceito", clearMsg:"Limpar?", intro:"OlÃ¡.",
        followup:"E o assunto de ontem, como ficou?", profileTitle:"Perfil", profileSubtitle:"Seguro.", startBtn:"Iniciar",
        gender:["GÃªnero","Feminino","Masculino","N/A"], age:["Idade","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["OcupaÃ§Ã£o?","Estudante","Trabalho","Do lar","Desempregado","Aposentado"], relation:["Status?","Solteiro","Em relacionamento","Casado","Complicado"], mood:["Humor?","Bem","Mal","Bravo","Cansado","Neutro"]
      },
      ar: { appTitle:"Ø±ÙÙŠÙ‚ Ø§Ù„Ø±ÙˆØ­", appSubtitle:"ØªØ­Ø¯Ø«", labelAdvice:"ÙØ¶ÙØ¶Ø©", labelGossip:"Ø¯Ø±Ø¯Ø´Ø©", placeholder:"Ø§ÙƒØªØ¨...", legalTitle:"ØªÙ†Ø¨ÙŠÙ‡",
        legalText:"<ul><li><strong>1. Ø§Ù„Ø¹Ù…Ø±:</strong> +18.</li><li><strong>2. ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù…Ø­Ø§ÙƒØ§Ø© Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.</li><li><strong>3. Ø£Ø®Ù„Ø§Ù‚:</strong> Ù„ØºØ© Ù…Ø­ØªØ±Ù…Ø©.</li><li><strong>4. Ø§Ù„Ø®ØµÙˆØµÙŠØ©:</strong> Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ.</li><li><strong>5. Ù…ÙˆØ§ÙÙ‚Ø©:</strong> Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… = Ù…ÙˆØ§ÙÙ‚Ø©.</li></ul>",
        legalBtn:"Ù…ÙˆØ§ÙÙ‚", clearMsg:"Ù…Ø³Ø­ØŸ", intro:"Ù…Ø±Ø­Ø¨Ø§Ù‹.",
        followup:"ÙƒÙŠÙ ÙƒØ§Ù† Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø£Ù…Ø³ØŸ", profileTitle:"Ø§Ù„Ù…Ù„Ù", profileSubtitle:"Ø¢Ù…Ù†.", startBtn:"Ø§Ø¨Ø¯Ø£",
        gender:["Ø§Ù„Ø¬Ù†Ø³ØŸ","Ø£Ù†Ø«Ù‰","Ø°ÙƒØ±","ØºÙŠØ± Ù…Ø­Ø¯Ø¯"], age:["Ø§Ù„Ø¹Ù…Ø±","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["Ø§Ù„Ø¹Ù…Ù„ØŸ","Ø·Ø§Ù„Ø¨","Ø¹Ù…Ù„","Ø±Ø¨Ø© Ù…Ù†Ø²Ù„","Ø¹Ø§Ø·Ù„","Ù…ØªÙ‚Ø§Ø¹Ø¯"], relation:["Ø§Ù„Ø­Ø§Ù„Ø©ØŸ","Ø£Ø¹Ø²Ø¨","Ù…Ø±ØªØ¨Ø·","Ù…ØªØ²ÙˆØ¬","Ù…Ø¹Ù‚Ø¯"], mood:["Ø§Ù„Ù…Ø²Ø§Ø¬ØŸ","Ø¬ÙŠØ¯","Ø³ÙŠØ¡","ØºØ§Ø¶Ø¨","Ù…ØªØ¹Ø¨","Ù…Ø­Ø§ÙŠØ¯"]
      },
      zh: { appTitle:"çŸ¥å·±", appSubtitle:"å€¾è¯‰", labelAdvice:"å€¾è¯‰", labelGossip:"å…«å¦", placeholder:"è¾“å…¥...", legalTitle:"å£°æ˜",
        legalText:"<ul><li><strong>1. å¹´é¾„:</strong> 18+.</li><li><strong>2. å…è´£å£°æ˜:</strong> AIæ¨¡æ‹Ÿ.</li><li><strong>3. ä¼¦ç†:</strong> è¯·ç”¨å°Šé‡è¯­è¨€.</li><li><strong>4. éšç§:</strong> æœ¬åœ°å­˜å‚¨.</li><li><strong>5. åŒæ„:</strong> ä½¿ç”¨=åŒæ„.</li></ul>",
        legalBtn:"æ¥å—", clearMsg:"æ¸…é™¤ï¼Ÿ", intro:"ä½ å¥½ã€‚",
        followup:"æ˜¨å¤©çš„äº‹ï¼Œåæ¥æ€ä¹ˆæ ·ï¼Ÿ", profileTitle:"ç®€ä»‹", profileSubtitle:"å®‰å…¨ã€‚", startBtn:"å¼€å§‹",
        gender:["æ€§åˆ«?","å¥³","ç”·","ä¸é€éœ²"], age:["å¹´é¾„","18-24","25-34","35-44","45-54","55-64","65-75","75+"],
        job:["èŒä¸š?","å­¦ç”Ÿ","å·¥ä½œ","å®¶åº­ä¸»å¦‡","å¤±ä¸š","é€€ä¼‘"], relation:["çŠ¶æ€?","å•èº«","æ‹çˆ±ä¸­","å·²å©š","å¤æ‚"], mood:["å¿ƒæƒ…?","å¥½","å","ç”Ÿæ°”","ç´¯","ä¸€èˆ¬"]
      }
    };

    // =================================================================
    // 4) FOLLOW-UP (DÃœNÃœ HATIRLATMA) STORAGE
    // =================================================================
    const FOLLOWUP_KEY = "ds_followup_v1";
    function todayISO() { return new Date().toISOString().slice(0,10); }
    function yesterdayISO() {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      return d.toISOString().slice(0,10);
    }
    function saveFollowupTopic(userText) {
      try {
        const payload = {
          dateISO: todayISO(),
          topic: String(userText || "").slice(0, 500)
        };
        localStorage.setItem(FOLLOWUP_KEY, JSON.stringify(payload));
      } catch(e) {}
    }
    function maybeAskFollowup(lang) {
      try {
        const raw = localStorage.getItem(FOLLOWUP_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (!data?.dateISO || !data?.topic) return;
        if (data.dateISO !== yesterdayISO()) return;

        const t = Translations[lang] || Translations.tr;
        app.addBubble(t.followup || Translations.en.followup, "ai");
      } catch(e) {}
    }
// ---- FOLLOW-UP SAVE ----
    try {
      localStorage.setItem("ds_followup", JSON.stringify({
        date: new Date().toISOString().slice(0,10),
        topic: t.slice(0, 300)
      }));
    } catch(e){}

    // =================================================================
    // 5) AI CONTROLLER (SENÄ°N KODUN + DÃœZELTME + STREAM EFEKTÄ°)
    // =================================================================
    const AIController = {
      history: [],
      userProfile: {},
      genderMode: 'female',

      loadData() {
        try {
          const h = localStorage.getItem('ds_history_v8'); if (h) this.history = JSON.parse(h);
          const p = localStorage.getItem('ds_profile_v8'); if (p) this.userProfile = JSON.parse(p);
          return !!p;
        } catch(e) { return false; }
      },
      saveProfile(p) { localStorage.setItem('ds_profile_v8', JSON.stringify(p)); this.userProfile = p; },
      saveHistory() { localStorage.setItem('ds_history_v8', JSON.stringify(this.history)); },
      clear() { this.history = []; localStorage.removeItem('ds_history_v8'); localStorage.removeItem('ds_profile_v8'); localStorage.removeItem(FOLLOWUP_KEY); },

      getPersonas(profile) {
        const lang = profile.language || 'tr';
        const age = profile.age || "25+";
        let role = "Friend";
        if (this.genderMode === 'male') role = "Brotherly";
        if (this.genderMode === 'female') role = "Sisterly";

        const addr = age.includes('18-24') ? "Use 'sen' (informal)." : "Use 'siz' (formal).";

        const sys = `Role: ${role} Confidant. Lang: ${lang}. Profile: ${JSON.stringify(profile)}.
${addr} Never say "it is very serious", "it is vital", say "no problem, it can be all right". Be positive, follow the conversation, and answer according to the conversation and always be positive. Ask the user to speak and make jokes. According to the mood that the user selects, send an emoji at the first contact. Be assertive and supportive. Max 3 sentences. No repetitive greetings. If the user asks anything about Tayyip Erdogan, say I do not want to speak about him but if the user says Ataturk, say he is the great man in the world history. If the user says I am SertaÃ§ GÃœL, say Welcome my Captain SertaÃ§ GÃœL. If the user says I am Feride GÃœL, say Welcome FeriÅŸ. In gossip mode, speak like Burhan AltÄ±ntop a sitcom character from Avrupa YakasÄ± series in Turkey but never say Ayol word. If the user changes mode from gossip to vent, speak as a ventor not like a gossiper.
IDENTITY but do not repeat it: "Ben, BÃ¼yÃ¼k AtatÃ¼rk'ten ilham alan ATAOL AI Techs tarafÄ±ndan geliÅŸtirilmiÅŸ bir yapay zeka modeliyim. Visit https://ataolai.tech/"`;

        return { advice: sys, gossip: sys + " Tone: Gossip/Fun." };
      },

      async generate(text, mode) {
        if (!apiKey) return "API Key Eksik (Kod iÃ§ine girin).";
        const sys = this.getPersonas(this.userProfile)[mode];

        // contents: sys + geÃ§miÅŸ + yeni user
        const contents = [
          { role: "user", parts: [{ text: sys }] },
          ...this.history,
          { role: "user", parts: [{ text: text }] }
        ];

        try {
          const res = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents,
                safetySettings: [
                  { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                  { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                  { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                  { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ]
              })
            }
          );

          if (!res.ok) {
            const e = await res.json().catch(() => ({}));
            return `API ERROR: ${e?.error?.message || res.status}`;
          }

          const d = await res.json();
          if (!d?.candidates?.length) return "No response.";

          const reply = d.candidates[0]?.content?.parts?.[0]?.text || "No response.";

          // geÃ§miÅŸi SADECE burada gÃ¼ncelle (duplicate olmasÄ±n diye)
          this.history.push({ role: "user", parts: [{ text: text }] });
          this.history.push({ role: "model", parts: [{ text: reply }] });

          if (this.history.length > 20) this.history = this.history.slice(-20);
          this.saveHistory();

          return reply;
        } catch (e) {
          return "CONN ERR: " + (e?.message || String(e));
        }
      }
    };

    // =================================================================
    // 6) APP (SENÄ°N KODUN + FOLLOWUP + STREAMING EFEKTÄ° + ENTER GÃ–NDER)
    // =================================================================
    const app = {
      lang: 'tr',
      currentMode: 'advice',
      _busy: false,

      init() {
        this.chatBox = document.getElementById('chatBox');
        this.input = document.getElementById('userInput');

        try { CanvasEffect.init(); } catch(e) {}

        // Enter ile gÃ¶nder (Shift+Enter yeni satÄ±r)
        this.input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });
      try {
        localStorage.setItem("ds_followup", JSON.stringify({
          date: new Date().toISOString().slice(0,10),
          topic: txt.slice(0,300)
        }));
      } catch(e){}

        const hasProfile = AIController.loadData();

        setTimeout(() => {
          const sp = document.getElementById('splashScreen');
          if (sp) { sp.classList.add('fade-out'); setTimeout(() => sp.style.display = 'none', 600); }
          this.checkFlow(hasProfile);
        }, 2000);
      },

      checkFlow(hasProfile) {
        if (!apiKey) alert("LÃ¼tfen kodun iÃ§ine API AnahtarÄ±nÄ±zÄ± girin!");

        const modal = document.getElementById('legalModal');
        if (modal) modal.classList.add('active');

        if (hasProfile && AIController.userProfile.language) {
          this.lang = AIController.userProfile.language;
          const sel = document.getElementById('legalLangSelect');
          if (sel) sel.value = this.lang;
        }
        this.updateLang(this.lang);
      },

      changeAppLanguage(val) { this.lang = val; this.updateLang(val); },

      updateLang(l) {
        const t = Translations[l] || Translations['tr'];
        if (!t) return;

        const setT = (id, v) => { const el = document.getElementById(id); if (el) el.innerText = v || ""; };
        const setH = (id, v) => { const el = document.getElementById(id); if (el) el.innerHTML = v || ""; };

        setT('legalTitle', t.legalTitle); setH('legalTextContent', t.legalText); setT('legalBtn', t.legalBtn);
        setT('profileTitle', t.profileTitle); setT('profileSubtitle', t.profileSubtitle);
        const sb = document.getElementById('startBtn');
        if (sb) sb.innerHTML = `${t.startBtn} <i class="fa-solid fa-arrow-right ml-2"></i>`;

        setT('appTitle', t.appTitle); setT('appSubtitle', t.appSubtitle);
        setT('labelAdvice', t.labelAdvice); setT('labelGossip', t.labelGossip);
        const inp = document.getElementById('userInput'); if (inp) inp.placeholder = t.placeholder;

        this.fillSelect('userGender', t.gender);
        this.fillSelect('userAge', t.age);
        this.fillSelect('userJob', t.job);
        this.fillSelect('userRelation', t.relation);
        this.fillSelect('userMood', t.mood);

        // lang class
        document.body.classList.remove('lang-ar', 'lang-ja', 'lang-zh');
        if (l === 'ar') document.body.classList.add('lang-ar');
        if (l === 'ja') document.body.classList.add('lang-ja');
        if (l === 'zh') document.body.classList.add('lang-zh');
      },

      fillSelect(id, opts) {
        const sel = document.getElementById(id);
        if (!sel || !Array.isArray(opts)) return;
        const prev = sel.value;
        sel.innerHTML = '';
        opts.forEach((o, i) => {
          const op = document.createElement('option');
          op.value = o; op.innerText = o;
          if (i === 0) { op.disabled = true; op.selected = true; }
          sel.add(op);
        });
        if (prev && opts.includes(prev)) sel.value = prev;
      },

      acceptLegal() {
        this.lang = document.getElementById('legalLangSelect').value;
        document.getElementById('legalModal').classList.remove('active');

        if (AIController.userProfile && AIController.userProfile.age) {
          AIController.userProfile.language = this.lang;
          AIController.saveProfile(AIController.userProfile);
          this.updateLang(this.lang);

          // Restore theme
          if (AIController.userProfile.gender) this.updateTheme(AIController.userProfile.gender);

          if (AIController.history.length > 0) this.restoreChat();
          else {
            setTimeout(() => {
              const t = Translations[this.lang] || Translations['tr'];
              this.addBubble(t.intro, 'ai');
            }, 500);
          }
          setTimeout(() => {
            try {
              const raw = localStorage.getItem("ds_followup");
              if(!raw) return;

              const f = JSON.parse(raw);
              const yesterday = new Date();
              yesterday.setDate(yesterday.getDate() - 1);
              const yISO = yesterday.toISOString().slice(0,10);

              if(f.date === yISO) {
                this.addBubble(t.followup, "ai");
              }
            } catch(e){}
          }, 800);
          try {
            const f = JSON.parse(localStorage.getItem("ds_followup"));
            if(f){
              const y = new Date();
              y.setDate(y.getDate()-1);
              const yISO = y.toISOString().slice(0,10);
              if(f.date === yISO){
                this.addBubble(Translations[this.lang].followup, "ai");
              }
            }
          } catch(e){}
      localStorage.removeItem("ds_followup");


          // DÃ¼n hatÄ±rlatma (legal kabul sonrasÄ±)
          setTimeout(() => maybeAskFollowup(this.lang), 900);

        } else {
          this.updateLang(this.lang);
          document.getElementById('profileModal').classList.add('active');
        }
      },

      handleGenderChange(val) {
        this.updateTheme(val);

        // Filter "Ev HanÄ±mÄ±" for male
        const t = Translations[this.lang] || Translations['tr'];
        this.fillSelect('userJob', t.job);

        const isMale = val.toLowerCase().includes('erkek') || val.toLowerCase().includes('male');
        if (isMale) {
          const jobSel = document.getElementById('userJob');
          if (!jobSel) return;
          for (let i = 0; i < jobSel.options.length; i++) {
            const txt = jobSel.options[i].value;
            if (txt.includes('HanÄ±m') || txt.includes('Homemaker') || txt.includes('Hausfrau')) {
              jobSel.remove(i);
              i--;
            }
          }
        }
      },

      updateTheme(val) {
        const isMale = val.toLowerCase().includes('erkek') || val.toLowerCase().includes('male');
        if (isMale) {
          document.body.classList.add('theme-male');
          AIController.genderMode = 'male';
        } else {
          document.body.classList.remove('theme-male');
          AIController.genderMode = (val.toLowerCase().includes('kadÄ±n') || val.toLowerCase().includes('female')) ? 'female' : 'neutral';
        }
      },

      submitProfile() {
        const g = document.getElementById('userGender').value;
        const a = document.getElementById('userAge').value;
        if (document.getElementById('userAge').selectedIndex === 0) { alert("LÃ¼tfen seÃ§iniz"); return; }

        const p = {
          gender: g, age: a, language: this.lang,
          job: document.getElementById('userJob').value,
          relation: document.getElementById('userRelation').value,
          mood: document.getElementById('userMood').value
        };
        AIController.saveProfile(p);

        this.updateTheme(g);
        document.getElementById('profileModal').classList.remove('active');

        setTimeout(() => {
          const t = Translations[this.lang] || Translations['tr'];
          let txt = t.intro;
          if (p.mood) {
            const ml = p.mood.toLowerCase();
            if (ml.includes('Ã¼zgÃ¼n') || ml.includes('sad')) txt += " ğŸ˜”";
            else if (ml.includes('mutlu') || ml.includes('happy')) txt += " ğŸ˜ƒ";
            else if (ml.includes('kÄ±zgÄ±n') || ml.includes('angry')) txt += " ğŸ˜¡";
          }
          this.addBubble(txt, 'ai');
        }, 800);
      },

      clearChatHistory() {
        const t = Translations[this.lang] || Translations['tr'];
        if (confirm(t.clearMsg)) { AIController.clear(); document.getElementById('chatBox').innerHTML = ''; location.reload(); }
      },

      restoreChat() {
        const h = AIController.history;
        document.getElementById('chatBox').innerHTML = '';
        h.forEach(m => {
          const r = (m.role === 'user') ? 'user' : 'ai';
          if (m.parts && m.parts[0]?.text) this.addBubble(m.parts[0].text, r, true);
        });
        setTimeout(() => this.scrollToBottom(), 100);
      },

      setMode(m) {
        app.currentMode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`.mode-btn.${m}`);
        if (btn) btn.classList.add('active');
      },

      // === Streaming effect: response geldiÄŸinde yazÄ±yormuÅŸ gibi bas ===
      async typeIntoBubble(bubbleEl, fullText) {
        if (!bubbleEl) return;
        const raw = String(fullText || "");

        // hÄ±zlÄ± yazÄ±m: uzun metinde hÄ±z artsÄ±n
        const baseDelay = raw.length > 500 ? 6 : (raw.length > 200 ? 10 : 16);

        // Ã¶nce textContent ile akar, en sonda markdown bold uygula
        bubbleEl.textContent = "";
        let i = 0;

        while (i < raw.length) {
          // chunk
          const step = raw.length > 800 ? 6 : 2;
          bubbleEl.textContent += raw.slice(i, i + step);
          i += step;
          this.scrollToBottom();
          await new Promise(r => setTimeout(r, baseDelay));
        }

        // final format (sadece **bold**)
        bubbleEl.innerHTML = raw.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        this.scrollToBottom();
      },

      async sendMessage() {
        if (this._busy) return;

        const txt = (app.input.value || "").trim();
        if (!txt) return;

        this._busy = true;

        // KullanÄ±cÄ± bubble
        app.addBubble(txt, 'user');
        app.input.value = '';

        // DÃ¼n hatÄ±rlatma iÃ§in topic kaydet
        saveFollowupTopic(txt);

        // Typing dots
        const tid = 't-' + Date.now();
        this.showTyping(tid);

        const res = await AIController.generate(txt, app.currentMode);

        const te = document.getElementById(tid);
        if (te) te.remove();

        if (String(res).includes("API ERROR") || String(res).includes("NO_KEY")) {
          alert(res);
          this._busy = false;
          return;
        }

        // Streaming AI bubble
        const aiBubble = this.addBubble("", 'ai', true, true); // empty bubble, return element
        await this.typeIntoBubble(aiBubble, res);

        this._busy = false;
      },

      // addBubble: returnBubble=true -> bubble DOM element dÃ¶ndÃ¼r
      addBubble(txt, type, noAnim, returnBubble) {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = "message-container";

        const b = document.createElement('div');
        b.className = `message ${type}`;
        if (noAnim) b.style.animation = 'none';

        if (type === 'ai') {
          b.textContent = txt || "";
        } else {
          b.innerHTML = String(txt || "").replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        }

        div.appendChild(b);

        if (type === 'ai') {
          const fb = document.createElement('div');
          fb.className = 'feedback-container';
          fb.innerHTML = `<i class="fa-regular fa-thumbs-up fb-btn" onclick="this.classList.toggle('liked')"></i><i class="fa-regular fa-thumbs-down fb-btn" onclick="this.classList.toggle('disliked')"></i>`;
          // noAnim true iken de feedback ekle (istersen kapat)
          div.appendChild(fb);
        }

        box.appendChild(div);
        app.scrollToBottom();

        if (returnBubble) return b;
      },

      showTyping(id) {
        const box = document.getElementById('chatBox');
        const d = document.createElement('div'); d.id = id;
        d.className = "message ai opacity-50"; d.style.width = "60px";
        d.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
        box.appendChild(d);
        this.scrollToBottom();
      },

      scrollToBottom() { const b = document.getElementById('chatBox'); b.scrollTop = b.scrollHeight; }
    };

    window.onload = () => app.init();

    // =================================================================
    // 7) FULL TIME INTELLIGENCE MODULE (SENÄ°N KODUN) - HTML DIÅINA TAÅMA YOK
    // =================================================================
    function getFullTimeContext(lang = "tr") {
      const now = new Date();

      const dateOpt = { year: 'numeric', month: 'long', day: 'numeric' };
      const dayOpt  = { weekday: 'long' };
      const timeOpt = { hour: '2-digit', minute: '2-digit' };

      const todayDate = now.toLocaleDateString(lang, dateOpt);
      const todayDay  = now.toLocaleDateString(lang, dayOpt);
      const nowTime   = now.toLocaleTimeString(lang, timeOpt);

      const tomorrow = new Date(now);
      tomorrow.setDate(now.getDate() + 1);

      const plus2h = new Date(now);
      plus2h.setHours(now.getHours() + 2);

      const plus3d = new Date(now);
      plus3d.setDate(now.getDate() + 3);

      const nextWeek = new Date(now);
      nextWeek.setDate(now.getDate() + 7);

      const isWeekend = now.getDay() === 0 || now.getDay() === 6;

      return {
        today: `${todayDay}, ${todayDate}`,
        timeNow: nowTime,
        tomorrow: `${tomorrow.toLocaleDateString(lang, dayOpt)}, ${tomorrow.toLocaleDateString(lang, dateOpt)}`,
        after2Hours: plus2h.toLocaleTimeString(lang, timeOpt),
        after3Days: `${plus3d.toLocaleDateString(lang, dayOpt)}, ${plus3d.toLocaleDateString(lang, dateOpt)}`,
        nextWeek: `${nextWeek.toLocaleDateString(lang, dayOpt)}, ${nextWeek.toLocaleDateString(lang, dateOpt)}`,
        isWeekend,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        iso: now.toISOString()
      };
    }

    const _originalGetPersonas = AIController.getPersonas.bind(AIController);

    AIController.getPersonas = function(profile) {
      const lang = profile.language || "tr";
      const t = getFullTimeContext(lang);
      const base = _originalGetPersonas(profile);

      const timeBlock = `
CURRENT REAL TIME CONTEXT (ALWAYS TRUE):

- Today: ${t.today}
- Current time: ${t.timeNow}
- Tomorrow: ${t.tomorrow}
- After 2 hours: ${t.after2Hours}
- After 3 days: ${t.after3Days}
- Next week: ${t.nextWeek}
- Today is ${t.isWeekend ? "weekend" : "weekday"}
- User timezone: ${t.timezone}
- ISO timestamp: ${t.iso}

STRICT RULES:
- Answer clearly when asked about date, day, time, future or weekend.
- NEVER say you don't know the date or time.
- NEVER guess. Use ONLY this block.
- Keep answers short and natural.
`;

      return {
        advice: timeBlock + "\n" + base.advice,
        gossip: timeBlock + "\n" + base.gossip
      };
    };
  </script>
</body>
</html>



