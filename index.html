<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Soul Confidant</title>
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111827">

  <link rel="apple-touch-icon" sizes="180x180" href="./icon-180.png">
  <link rel="icon" type="image/png" href="./icon-180.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+SC:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root { --primary-gradient: linear-gradient(135deg, #f472b6 0%, #a78bfa 100%); --user-msg-bg: linear-gradient(135deg, #ec4899, #be185d); --btn-bg: #ec4899; --icon-bg: linear-gradient(135deg, #f472b6 0%, #a78bfa 100%); }
    body.theme-male { --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%); --user-msg-bg: linear-gradient(135deg, #2563eb, #1d4ed8); --btn-bg: #2563eb; --icon-bg: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%); }
    body { font-family: 'Nunito', sans-serif; background-color: #111827; color: #e2e8f0; overflow: hidden; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
    .app-container { width: 100%; height: 100%; background: linear-gradient(180deg, #1f2937 0%, #0f172a 100%); display: flex; flex-direction: column; position: absolute; inset: 0; margin: 0 auto; max-width: 600px; }
    @media (min-width: 768px) { .app-container { border-left: 1px solid #374151; border-right: 1px solid #374151; } }
    .splash-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1e1b4b 0%, #0f172a 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
    .splash-logo { font-size: 4.5rem; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; }
    .splash-title { font-size: 2.5rem; font-weight: 900; color: white; }
    .splash-subtitle { color: #94a3b8; font-size: 0.9rem; margin-top: 0.5rem; font-weight: 600; letter-spacing: 1px; }
    .splash-screen.fade-out { opacity: 0; pointer-events: none; }
    .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.98); z-index: 100; display: none; flex-direction: column; justify-content: center; padding: 24px; }
    .modal-overlay.active { display: flex; }
    .form-select { background-color: #1f2937; border: 1px solid #374151; color: white; padding: 12px; border-radius: 12px; width: 100%; margin-bottom: 12px; outline: none; transition: border-color 0.3s; font-size: 0.95rem; }
    .form-select:focus { border-color: #ec4899; }
    .lang-select-mini { background: #374151; color: white; border: 1px solid #4b5563; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; outline: none; }
    .legal-box { background: #111827; border: 1px solid #374151; padding: 15px; border-radius: 8px; font-size: 0.85rem; color: #cbd5e1; margin-bottom: 20px; max-height: 250px; overflow-y: auto; line-height: 1.6; }
    .chat-area { flex: 1; overflow-y: auto; padding: 16px; scroll-behavior: smooth; overscroll-behavior-y: contain; }
    .message-container { display: flex; flex-direction: column; width: 100%; margin-bottom: 16px; animation: popIn 0.3s ease; }
    .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.3); word-wrap: break-word; white-space: pre-wrap; }
    .message.user { align-self: flex-end; background: var(--user-msg-bg); color: white; border-bottom-right-radius: 2px; }
    .message.ai { align-self: flex-start; background: #334155; color: #f1f5f9; border-bottom-left-radius: 2px; border: 1px solid #475569; }
    .feedback-container { display: flex; gap: 15px; margin-top: 6px; margin-left: 10px; opacity: 0.6; }
    .fb-btn { cursor: pointer; color: #6b7280; font-size: 1rem; transition: 0.2s; }
    .fb-btn:hover { color: white; transform: scale(1.2); }
    .fb-btn.liked { color: #34d399; }
    .fb-btn.disliked { color: #f87171; }
    .input-area { background: #1f2937; padding: 16px; border-top: 1px solid #374151; display: flex; flex-direction: column; gap: 10px; padding-bottom: calc(env(safe-area-inset-bottom) + 20px); box-shadow: 0 -4px 20px rgba(0,0,0,0.4); }
    .send-btn-custom { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s; background-color: var(--btn-bg); color: white; }
    .send-btn-custom:active { transform: scale(0.95); }
    .mode-switch { display: flex; background: #111827; padding: 4px; border-radius: 10px; margin-bottom: 5px; border: 1px solid #374151; }
    .mode-btn { flex: 1; padding: 8px; text-align: center; border-radius: 8px; font-size: 0.8rem; font-weight: 700; cursor: pointer; color: #6b7280; transition: 0.3s; user-select: none; }
    .mode-btn.active.advice { background: #374151; color: #f472b6; }
    .mode-btn.active.gossip { background: #4c1d95; color: #e9d5ff; }
    .header-icon-bg { background: var(--icon-bg); }
    @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .typing-dots span { display: inline-block; width: 6px; height: 6px; background: #cbd5e1; border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; } .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    body.lang-ja { font-family: 'Noto Sans JP', sans-serif; } body.lang-zh { font-family: 'Noto Sans SC', sans-serif; } body.lang-ar { font-family: 'Noto Sans Arabic', sans-serif; direction: rtl; }
  </style>
</head>
<body>
  <div id="mainApp" class="app-container">
    <div id="splashScreen" class="splash-screen relative overflow-hidden">
      <canvas id="splashCanvas" class="absolute inset-0"></canvas>
      <div class="relative z-10 text-center">
        <div class="splash-logo"><i class="fa-solid fa-ear-listen"></i></div>
        <h1 class="splash-title">SOUL CONFIDANT</h1>
        <p class="splash-subtitle">Generated with responsibility by ATAOL AI Techs</p>
      </div>
    </div>

    <!-- 1. YASAL UYARI (10 DÄ°L - DÃœZELTÄ°LDÄ°) -->
    <div id="legalModal" class="modal-overlay">
      <div class="w-full max-w-sm mx-auto mb-4 flex justify-end">
        <select id="legalLangSelect" class="lang-select-mini" onchange="app.changeAppLanguage(this.value)">
          <option value="en" selected>ğŸ‡ºğŸ‡¸ English</option>
          <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
          <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
          <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
          <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
          <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
          <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
          <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
          <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        </select>
      </div>
      <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 w-full max-w-md mx-auto">
        <h2 id="legalTitle" class="text-xl font-bold text-white mb-4 text-center">Legal Disclaimer</h2>
        <div id="legalTextContent" class="legal-box"></div>
        <button id="legalBtn" onclick="app.acceptLegal()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl mt-2 transition">I Accept</button>
      </div>
    </div>

    <!-- 2. PROFÄ°L -->
    <div id="profileModal" class="modal-overlay">
      <div class="w-full max-w-sm mx-auto">
        <div class="text-center mb-6">
          <div class="w-16 h-16 rounded-full header-icon-bg flex items-center justify-center text-white text-2xl mx-auto mb-3 shadow-lg"><i class="fa-solid fa-user"></i></div>
          <h2 id="profileTitle" class="text-xl font-bold text-white">Let's Know You</h2>
          <p id="profileSubtitle" class="text-gray-400 text-xs mt-1">Your safe space, non-judgmental.</p>
        </div>
        <form onsubmit="event.preventDefault(); app.submitProfile();">
          <select id="userGender" class="form-select" onchange="app.handleGenderChange(this.value)"></select>
          <select id="userAge" class="form-select"></select>
          <select id="userJob" class="form-select"></select>
          <select id="userRelation" class="form-select"></select>
          <select id="userMood" class="form-select"></select>
          <button type="submit" id="startBtn" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold py-3 rounded-xl mt-4 shadow-lg transform active:scale-95 transition">Start</button>
          <button type="button" id="skipBtn" onclick="app.skipProfile()" class="w-full bg-transparent border border-gray-600 text-gray-400 font-medium py-2 rounded-xl mt-3 hover:text-white hover:border-gray-400 transition text-sm">Skip (Anonymous)</button>
        </form>
      </div>
    </div>

    <header class="p-4 flex items-center justify-between border-b border-gray-700 bg-gray-900 z-10 sticky top-0">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full header-icon-bg flex items-center justify-center text-white font-bold text-lg transition-colors duration-500"><i class="fa-solid fa-ear-listen"></i></div>
        <div>
          <h1 id="appTitle" class="font-bold text-white">Soul Confidant</h1>
          <span id="appSubtitle" class="text-xs text-pink-400">Good to talk</span>
        </div>
      </div>
      <button onclick="app.clearChatHistory()" class="w-12 h-12 rounded-full border border-gray-600 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-800 active:scale-90 active:bg-red-900 active:text-white transition-all duration-150 mr-1 cursor-pointer z-50"><i class="fa-solid fa-trash-can text-lg"></i></button>
    </header>

    <div id="chatBox" class="chat-area flex flex-col"></div>

    <div class="input-area">
      <div class="mode-switch">
        <div id="btnAdvice" class="mode-btn active advice" onclick="app.setMode('advice')"><i class="fa-solid fa-heart mr-1"></i> <span id="labelAdvice">Vent</span></div>
        <div id="btnGossip" class="mode-btn gossip" onclick="app.setMode('gossip')"><i class="fa-solid fa-bolt mr-1"></i> <span id="labelGossip">Gossip</span></div>
      </div>
      <div class="flex gap-2 items-end">
        <textarea id="userInput" rows="1" class="w-full bg-gray-800 text-white rounded-xl px-4 py-3 border border-gray-600 focus:border-pink-500 outline-none resize-none text-sm" placeholder="Type here..."></textarea>
        <button id="sendBtn" onclick="app.sendMessage()" class="send-btn-custom text-white flex-shrink-0 shadow-lg"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <script>
    const p1 = "AIzaSyDZQttG";
    const p2 = "iJrIPowg9y4sBCXx_yYBmNQM0m8";
    const apiKey = p1 + p2;

    const CanvasEffect={canvas:null,ctx:null,particles:[],animationId:null,init(){this.canvas=document.getElementById("splashCanvas");if(!this.canvas)return;this.ctx=this.canvas.getContext("2d");if(!this.ctx)return;this.resize();window.addEventListener("resize",()=>this.resize());this.createParticles();this.animate()},resize(){if(this.canvas){this.canvas.width=window.innerWidth;this.canvas.height=window.innerHeight}},createParticles(){if(!this.canvas)return;const count=Math.floor(this.canvas.width*this.canvas.height/10000);this.particles=[];for(let i=0;i<count;i++){this.particles.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,vx:(Math.random()-.5)*.5,vy:(Math.random()-.5)*.5,size:Math.random()*2+1,alpha:Math.random()*.5+.1})}},animate(){if(!this.ctx)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let i=0;i<this.particles.length;i++){const p=this.particles[i];p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>this.canvas.width)p.vx*=-1;if(p.y<0||p.y>this.canvas.height)p.vy*=-1;this.ctx.fillStyle=`rgba(167, 139, 250, ${p.alpha})`;this.ctx.beginPath();this.ctx.arc(p.x,p.y,p.size,0,Math.PI*2);this.ctx.fill()}this.animationId=requestAnimationFrame(()=>this.animate())},stop(){if(this.animationId)cancelAnimationFrame(this.animationId)}};

    // --- TRANSLATIONS (DÃœZELTÄ°LDÄ°: TÃœM DÄ°LLER DOLU) ---
    const Translations = {
      en: { 
        appTitle:"Soul Confidant", appSubtitle:"Good to talk", labelAdvice:"Vent", labelGossip:"Gossip", placeholder:"Type here...", 
        legalTitle:"Legal Disclaimer", 
        legalText:"<ul><li><strong>1. Age Limit:</strong> 18+ required.</li><li><strong>2. Disclaimer:</strong> AI simulation.</li><li><strong>3. Ethics:</strong> Respectful language only.</li><li><strong>4. Privacy:</strong> Local data storage.</li><li><strong>5. Usage:</strong> For functionality only.</li></ul>", 
        legalBtn:"I Accept", clearMsg:"Clear history?", intro:"Hey there! I'm here to listen.", 
        profileTitle:"Let's Know You", profileSubtitle:"Safe space.", startBtn:"Start", skipBtn:"Skip (Anonymous)", 
        gender:["Gender (Optional)","Female","Male","Prefer not to say"], age:["Age (Optional)","Prefer not to say","18+"], job:["Job (Optional)","Prefer not to say","Student","Worker"], relation:["Status (Optional)","Prefer not to say","Single"], mood:["Mood (Optional)","Neutral","Happy","Sad","Angry"] 
      },
      tr: { 
        appTitle:"Dert SÄ±rdaÅŸÄ±", appSubtitle:"Seninle konuÅŸmak iyi gelecek", labelAdvice:"DertleÅŸme", labelGossip:"GÄ±ybet", placeholder:"Yaz bakalÄ±m...", 
        legalTitle:"Yasal UyarÄ±", 
        legalText:"<ul><li><strong>1. YaÅŸ:</strong> 18+ yaÅŸ sÄ±nÄ±rÄ±.</li><li><strong>2. AI:</strong> Yapay zeka ile sohbet.</li><li><strong>3. Etik:</strong> SaygÄ±lÄ± dil kullanÄ±nÄ±z.</li><li><strong>4. Gizlilik:</strong> Veriler cihazda saklanÄ±r.</li><li><strong>5. KullanÄ±m:</strong> Sadece iÅŸlevsellik iÃ§in.</li></ul>", 
        legalBtn:"Kabul Ediyorum", clearMsg:"Sohbet geÃ§miÅŸi silinsin mi?", intro:"Selam! Seni dinlemek iÃ§in buradayÄ±m.", 
        profileTitle:"Seni TanÄ±yalÄ±m", profileSubtitle:"YargÄ±sÄ±z, gÃ¼venli dert ortaÄŸÄ±n.", startBtn:"BaÅŸla", skipBtn:"Åimdilik Atla", 
        gender:["Cinsiyet (Opsiyonel)","KadÄ±n","Erkek","Belirtmek Ä°stemiyorum"], age:["YaÅŸ (Opsiyonel)","Belirtmek Ä°stemiyorum","18+"], job:["Meslek (Opsiyonel)","Belirtmek Ä°stemiyorum","Ã–ÄŸrenci","Ã‡alÄ±ÅŸan"], relation:["Ä°liÅŸki (Opsiyonel)","Belirtmek Ä°stemiyorum","Bekar"], mood:["Ruh halin nasÄ±l? (Opsiyonel)","NÃ¶tr","Mutlu","ÃœzgÃ¼n","KÄ±zgÄ±n"] 
      },
      de: { 
        appTitle:"Seelenverwandter", appSubtitle:"Es tut gut zu reden", labelAdvice:"Reden", labelGossip:"Klatsch", placeholder:"Schreiben...", 
        legalTitle:"Rechtlicher Hinweis", 
        legalText:"<ul><li><strong>1. Altersgrenze:</strong> 18+ erforderlich.</li><li><strong>2. Haftungsausschluss:</strong> KI-Simulation.</li><li><strong>3. Ethik:</strong> Respektvolle Sprache.</li><li><strong>4. Datenschutz:</strong> Lokale Speicherung.</li><li><strong>5. Nutzung:</strong> Nur fÃ¼r FunktionalitÃ¤t.</li></ul>", 
        legalBtn:"Ich stimme zu", clearMsg:"LÃ¶schen?", intro:"Hallo, ich hÃ¶re zu.", 
        profileTitle:"Dich Kennenlernen", profileSubtitle:"Sicherer Raum.", startBtn:"Starten", skipBtn:"Ãœberspringen", 
        gender:["Geschlecht (Optional)","Weiblich","MÃ¤nnlich","Keine Angabe"], age:["Alter (Optional)","Keine Angabe","18+"], job:["Beruf (Optional)","Keine Angabe","Student","Arbeit"], relation:["Status (Optional)","Keine Angabe","Single"], mood:["Laune? (Optional)","Neutral","Gut","Schlecht"] 
      },
      fr: { 
        appTitle:"Confident", appSubtitle:"Parler fait du bien", labelAdvice:"Confier", labelGossip:"Potins", placeholder:"Ã‰crivez...", 
        legalTitle:"Avis LÃ©gal", 
        legalText:"<ul><li><strong>1. Ã‚ge:</strong> 18+ requis.</li><li><strong>2. Clause:</strong> Simulation IA.</li><li><strong>3. Ã‰thique:</strong> Langage respectueux.</li><li><strong>4. ConfidentialitÃ©:</strong> DonnÃ©es locales.</li><li><strong>5. Usage:</strong> FonctionnalitÃ© uniquement.</li></ul>", 
        legalBtn:"J'accepte", clearMsg:"Effacer?", intro:"Bonjour, je vous Ã©coute.", 
        profileTitle:"Faisons Connaissance", profileSubtitle:"Espace sÃ»r.", startBtn:"Commencer", skipBtn:"Passer", 
        gender:["Genre (Optionnel)","Femme","Homme","N/A"], age:["Ã‚ge (Optionnel)","N/A","18+"], job:["Emploi (Optionnel)","N/A","Ã‰tudiant","Travail"], relation:["Statut (Optionnel)","N/A","CÃ©libataire"], mood:["Humeur? (Optionnel)","Neutre","Bien","Mal"] 
      },
      es: { 
        appTitle:"Confidente", appSubtitle:"Hablar ayuda", labelAdvice:"Desahogo", labelGossip:"Chisme", placeholder:"Escribe...", 
        legalTitle:"Aviso Legal", 
        legalText:"<ul><li><strong>1. Edad:</strong> 18+ requerido.</li><li><strong>2. Aviso:</strong> SimulaciÃ³n IA.</li><li><strong>3. Ã‰tica:</strong> Lenguaje respetuoso.</li><li><strong>4. Privacidad:</strong> Datos locales.</li><li><strong>5. Uso:</strong> Solo funcionalidad.</li></ul>", 
        legalBtn:"Aceptar", clearMsg:"Â¿Borrar?", intro:"Hola, te escucho.", 
        profileTitle:"Perfil", profileSubtitle:"Seguro.", startBtn:"Iniciar", skipBtn:"Saltar", 
        gender:["GÃ©nero (Opcional)","Mujer","Hombre","N/A"], age:["Edad (Opcional)","N/A","18+"], job:["OcupaciÃ³n (Opcional)","N/A","Estudiante"], relation:["Estado (Opcional)","N/A","Soltero"], mood:["Ãnimo (Opcional)","Neutral","Bien","Mal"] 
      },
      ru: { 
        appTitle:"Ğ”ÑƒÑˆĞµĞ²Ğ½Ñ‹Ğ¹ Ğ”Ñ€ÑƒĞ³", appSubtitle:"Ğ Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ¿Ğ¾Ğ¼Ğ¾Ğ¶ĞµÑ‚", labelAdvice:"Ğ”ÑƒÑˆĞ°", labelGossip:"Ğ¡Ğ¿Ğ»ĞµÑ‚Ğ½Ğ¸", placeholder:"ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ...", 
        legalTitle:"Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ", 
        legalText:"<ul><li><strong>1. Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚:</strong> 18+ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾.</li><li><strong>2. ĞÑ‚ĞºĞ°Ğ·:</strong> Ğ˜Ğ˜-ÑĞ¸Ğ¼ÑƒĞ»ÑÑ†Ğ¸Ñ.</li><li><strong>3. Ğ­Ñ‚Ğ¸ĞºĞ°:</strong> Ğ£Ğ²Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ.</li><li><strong>4. ĞŸÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ:</strong> Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾.</li><li><strong>5. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:</strong> Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸.</li></ul>", 
        legalBtn:"ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ", clearMsg:"ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ?", intro:"ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ñ ÑĞ»ÑƒÑˆĞ°Ñ.", 
        profileTitle:"ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", profileSubtitle:"Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾.", startBtn:"ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ", skipBtn:"ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ", 
        gender:["ĞŸĞ¾Ğ» (ĞĞ¿Ñ†.)","Ğ–ĞµĞ½","ĞœÑƒĞ¶","ĞĞµÑ‚"], age:["Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚ (ĞĞ¿Ñ†.)","ĞĞµÑ‚","18+"], job:["Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° (ĞĞ¿Ñ†.)","ĞĞµÑ‚","Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚"], relation:["Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ (ĞĞ¿Ñ†.)","ĞĞµÑ‚","Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´ĞµĞ½"], mood:["ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ (ĞĞ¿Ñ†.)","ĞĞ¾Ñ€Ğ¼","Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾","ĞŸĞ»Ğ¾Ñ…Ğ¾"] 
      },
      ja: { 
        appTitle:"å¿ƒã®å‹", appSubtitle:"è©±ãã†", labelAdvice:"ç›¸è«‡", labelGossip:"å™‚è©±", placeholder:"å…¥åŠ›...", 
        legalTitle:"å…è²¬äº‹é …", 
        legalText:"<ul><li><strong>1. å¹´é½¢:</strong> 18æ­³ä»¥ä¸Š.</li><li><strong>2. å…è²¬:</strong> AIã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³.</li><li><strong>3. å€«ç†:</strong> ä¸å¯§ãªè¨€è‘‰.</li><li><strong>4. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼:</strong> ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜.</li><li><strong>5. ç”¨é€”:</strong> æ©Ÿèƒ½ã®ã¿.</li></ul>", 
        legalBtn:"åŒæ„", clearMsg:"å‰Šé™¤ï¼Ÿ", intro:"ã“ã‚“ã«ã¡ã¯ã€‚", 
        profileTitle:"ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«", profileSubtitle:"å®‰å¿ƒã€‚", startBtn:"é–‹å§‹", skipBtn:"ã‚¹ã‚­ãƒƒãƒ—", 
        gender:["æ€§åˆ¥ (ä»»æ„)","å¥³æ€§","ç”·æ€§","å›ç­”ãªã—"], age:["å¹´é½¢ (ä»»æ„)","å›ç­”ãªã—","18+"], job:["è·æ¥­ (ä»»æ„)","å›ç­”ãªã—","å­¦ç”Ÿ"], relation:["çŠ¶æ…‹ (ä»»æ„)","å›ç­”ãªã—","ç‹¬èº«"], mood:["æ°—åˆ† (ä»»æ„)","æ™®é€š","è‰¯ã„","æ‚ªã„"] 
      },
      pt: { 
        appTitle:"Confidente", appSubtitle:"Falar faz bem", labelAdvice:"Desabafo", labelGossip:"Fofoca", placeholder:"Digite...", 
        legalTitle:"Aviso Legal", 
        legalText:"<ul><li><strong>1. Idade:</strong> 18+ necessÃ¡rio.</li><li><strong>2. Aviso:</strong> SimulaÃ§Ã£o IA.</li><li><strong>3. Ã‰tica:</strong> Respeito.</li><li><strong>4. Privacidade:</strong> Local.</li><li><strong>5. Uso:</strong> Funcionalidade apenas.</li></ul>", 
        legalBtn:"Aceitar", clearMsg:"Limpar?", intro:"OlÃ¡, estou ouvindo.", 
        profileTitle:"Perfil", profileSubtitle:"Seguro.", startBtn:"Iniciar", skipBtn:"Pular", 
        gender:["GÃªnero (Opcional)","Feminino","Masculino","N/A"], age:["Idade (Opcional)","N/A","18+"], job:["Trabalho (Opcional)","N/A","Estudante"], relation:["Status (Opcional)","N/A","Solteiro"], mood:["Humor (Opcional)","Neutro","Bem","Mal"] 
      },
      ar: { 
        appTitle:"Ø±ÙÙŠÙ‚ Ø§Ù„Ø±ÙˆØ­", appSubtitle:"ÙØ¶ÙØ¶", labelAdvice:"Ù†ØµÙŠØ­Ø©", labelGossip:"Ø¯Ø±Ø¯Ø´Ø©", placeholder:"Ø§ÙƒØªØ¨...", 
        legalTitle:"ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø§Ù†ÙˆÙ†ÙŠ", 
        legalText:"<ul><li><strong>1. Ø§Ù„Ø¹Ù…Ø±:</strong> 18+ Ù…Ø·Ù„ÙˆØ¨.</li><li><strong>2. ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù…Ø­Ø§ÙƒØ§Ø© Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.</li><li><strong>3. Ø£Ø®Ù„Ø§Ù‚:</strong> Ù„ØºØ© Ù…Ø­ØªØ±Ù…Ø©.</li><li><strong>4. Ø§Ù„Ø®ØµÙˆØµÙŠØ©:</strong> Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ.</li><li><strong>5. Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong> Ù„Ù„ÙˆØ¸Ø§Ø¦Ù ÙÙ‚Ø·.</li></ul>", 
        legalBtn:"Ù…ÙˆØ§ÙÙ‚", clearMsg:"Ù…Ø³Ø­ØŸ", intro:"Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ Ø£Ø³Ù…Ø¹Ùƒ.", 
        profileTitle:"Ø§Ù„Ù…Ù„Ù", profileSubtitle:"Ø¢Ù…Ù†.", startBtn:"Ø§Ø¨Ø¯Ø£", skipBtn:"ØªØ®Ø·ÙŠ", 
        gender:["Ø§Ù„Ø¬Ù†Ø³ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)","Ø£Ù†Ø«Ù‰","Ø°ÙƒØ±","Ù„Ø§"], age:["Ø§Ù„Ø¹Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)","Ù„Ø§","18+"], job:["Ø§Ù„Ø¹Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)","Ù„Ø§","Ø·Ø§Ù„Ø¨"], relation:["Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)","Ù„Ø§","Ø£Ø¹Ø²Ø¨"], mood:["Ø§Ù„Ù…Ø²Ø§Ø¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)","Ø¹Ø§Ø¯ÙŠ","Ø¬ÙŠØ¯","Ø³ÙŠØ¡"] 
      },
      zh: { 
        appTitle:"çŸ¥å·±", appSubtitle:"å€¾è¯‰", labelAdvice:"å€¾è¯‰", labelGossip:"å…«å¦", placeholder:"è¾“å…¥...", 
        legalTitle:"æ³•å¾‹å£°æ˜", 
        legalText:"<ul><li><strong>1. å¹´é¾„:</strong> 18å²ä»¥ä¸Š.</li><li><strong>2. å£°æ˜:</strong> AIæ¨¡æ‹Ÿ.</li><li><strong>3. ä¼¦ç†:</strong> å°Šé‡è¯­è¨€.</li><li><strong>4. éšç§:</strong> æœ¬åœ°å­˜å‚¨.</li><li><strong>5. ç”¨é€”:</strong> ä»…é™åŠŸèƒ½.</li></ul>", 
        legalBtn:"æ¥å—", clearMsg:"æ¸…é™¤ï¼Ÿ", intro:"ä½ å¥½ï¼Œæˆ‘åœ¨å¬ã€‚", 
        profileTitle:"ç®€ä»‹", profileSubtitle:"å®‰å…¨ã€‚", startBtn:"å¼€å§‹", skipBtn:"è·³è¿‡", 
        gender:["æ€§åˆ« (å¯é€‰)","å¥³","ç”·","ä¸å¡«"], age:["å¹´é¾„ (å¯é€‰)","ä¸å¡«","18+"], job:["èŒä¸š (å¯é€‰)","ä¸å¡«","å­¦ç”Ÿ"], relation:["çŠ¶æ€ (å¯é€‰)","ä¸å¡«","å•èº«"], mood:["å¿ƒæƒ… (å¯é€‰)","ä¸€èˆ¬","å¥½","å"] 
      }
    };

    // --- AI CONTROLLER ---
    const AIController = {
      history: [], userProfile: {}, genderMode: 'female',
      loadData() { try { const h=localStorage.getItem('ds_history_v8'); if(h)this.history=JSON.parse(h); const p=localStorage.getItem('ds_profile_v8'); if(p)this.userProfile=JSON.parse(p); return !!p; } catch(e){return false;} },
      saveProfile(p) { localStorage.setItem('ds_profile_v8', JSON.stringify(p)); this.userProfile = p; },
      saveHistory() { localStorage.setItem('ds_history_v8', JSON.stringify(this.history)); },
      clear() { this.history=[]; localStorage.removeItem('ds_history_v8'); localStorage.removeItem('ds_profile_v8'); },
      
      getPersonas(profile) {
        const lang = profile.language || 'en';
        const targetLang = lang === 'tr' ? "Turkish" : (lang === 'en' ? "English" : lang);
        let addressStyle = "Speak casually like a close friend.";
        if (lang === 'tr') addressStyle = "KullanÄ±cÄ±ya kesinlikle 'SEN' diye hitap et. Ã‡ok samimi, yakÄ±n bir arkadaÅŸ gibi konuÅŸ. Asla 'Siz' deme.";
        
        // Human Touch Prompt
        const baseIdentity = `
        IDENTITY: You are Soul Confidant, an empathetic friend. NOT an AI assistant.
        STRICT RULES:
        1. LANGUAGE: Reply ONLY in ${targetLang}.
        2. TONE: ${addressStyle}. Short sentences. WhatsApp chat style.
        3. LENGTH: Keep it short (max 2-3 sentences). Don't give long advice.
        4. ENGAGEMENT: Ask simple questions back. "Really?", "Then what happened?"
        5. MOOD: User feels "${profile.mood||'Neutral'}". Be supportive or fun accordingly.
        `;
        return { advice: baseIdentity + " MODE: Supportive/Vent.", gossip: baseIdentity + " MODE: Gossip/Fun." };
      },
    };

    // --- APP LOGIC ---
    const app = {
      lang: 'en', currentMode: 'advice', _busy: false,
      init() {
        this.chatBox = document.getElementById('chatBox'); this.input = document.getElementById('userInput');
        try { CanvasEffect.init(); } catch(e){}
        this.input.addEventListener('keydown', (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); } });
        const hasProfile = AIController.loadData();
        setTimeout(() => { document.getElementById('splashScreen').classList.add('fade-out'); setTimeout(() => document.getElementById('splashScreen').style.display = 'none', 600); this.checkFlow(hasProfile); }, 2000);
      },
      checkFlow(hasProfile) {
        const modal = document.getElementById('legalModal');
        if(modal) modal.classList.add('active');
        if(hasProfile && AIController.userProfile.language) { this.lang = AIController.userProfile.language; document.getElementById('legalLangSelect').value = this.lang; }
        this.updateLang(this.lang);
      },
      changeAppLanguage(val) { this.lang = val; this.updateLang(val); },
      updateLang(l) {
        const t = Translations[l] || Translations['en'];
        if(!t) return;
        const setT = (id, v) => { const el = document.getElementById(id); if (el) el.innerText = v || ""; };
        const setH = (id, v) => { const el = document.getElementById(id); if (el) el.innerHTML = v || ""; };
        setT('legalTitle',t.legalTitle); setH('legalTextContent',t.legalText); setT('legalBtn',t.legalBtn);
        setT('profileTitle',t.profileTitle); setT('profileSubtitle',t.profileSubtitle); setT('startBtn',t.startBtn); setT('skipBtn',t.skipBtn);
        setT('appTitle',t.appTitle); setT('appSubtitle',t.appSubtitle); setT('labelAdvice',t.labelAdvice); setT('labelGossip',t.labelGossip);
        const inp = document.getElementById('userInput'); if(inp) inp.placeholder = t.placeholder;
        this.fillSelect('userGender',t.gender); this.fillSelect('userAge',t.age); this.fillSelect('userJob',t.job); this.fillSelect('userRelation',t.relation); this.fillSelect('userMood',t.mood);
      },
      fillSelect(id, opts) {
        const sel = document.getElementById(id); if(!sel) return; sel.innerHTML = '';
        opts.forEach((o, i) => { const op = document.createElement('option'); op.value = o; op.innerText = o; if(i===0) op.selected = true; sel.add(op); });
      },
      acceptLegal() {
        document.getElementById('legalModal').classList.remove('active');
        const hasProfile = AIController.loadData();
        if(hasProfile) {
             AIController.userProfile.language = this.lang; AIController.saveProfile(AIController.userProfile); this.updateLang(this.lang);
             if(AIController.userProfile.gender) this.handleGenderChange(AIController.userProfile.gender);
             if(AIController.history.length > 0) this.restoreChat(); else this.startApp();
        } else {
             this.updateLang(this.lang); document.getElementById('profileModal').classList.add('active');
        }
      },
      handleGenderChange(val) { const isMale = val.toLowerCase().includes('male') || val.toLowerCase().includes('erkek'); if(isMale) document.body.classList.add('theme-male'); else document.body.classList.remove('theme-male'); },
      submitProfile() {
        this.userProfile = { gender: document.getElementById('userGender').value, age: document.getElementById('userAge').value, language: this.lang, mood: document.getElementById('userMood').value };
        AIController.saveProfile(this.userProfile); this.handleGenderChange(this.userProfile.gender); this.startApp();
      },
      skipProfile() {
        AIController.userProfile = { gender: 'N/A', age: '18+', language: this.lang, mood: 'Neutral' };
        AIController.saveProfile(AIController.userProfile); this.startApp();
      },
      startApp() {
        document.getElementById('profileModal').classList.remove('active');
        const t = Translations[this.lang] || Translations['en'];
        let firstMsg = t.intro;
        this.addBubble(firstMsg, 'ai');
      },
      async sendMessage() {
        if (this._busy) return;
        const txt = this.input.value.trim(); if (!txt) return;
        this._busy = true; this.addBubble(txt, 'user'); this.input.value = '';
        const loadingId = this.addBubble('...', 'ai', true);
        
        const sys = AIController.getPersonas(AIController.userProfile)[this.currentMode];
        const full = `${sys}\n\nUser: ${txt}`;

        try {
            // DIRECT API (NO CLOUDFLARE = NO CONNECTION ERROR)
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({ contents: [{ parts: [{ text: full }] }] }) 
            });
            const data = await res.json();
            const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "...";
            this.removeMessage(loadingId);
            this.addBubble(reply, 'ai');
        } catch(e) {
            this.removeMessage(loadingId);
            this.addBubble("Connection Error.", 'ai');
        }
        this._busy = false;
      },
      addBubble(txt, type, isLoading=false) {
        const d = document.createElement('div'); d.className = "message-container";
        const b = document.createElement('div'); b.className = `message ${type}`; b.innerText = txt;
        if(isLoading){ b.id = 'loading-msg'; b.classList.add('animate-pulse'); }
        d.appendChild(b); this.chatBox.appendChild(d); this.chatBox.scrollTop = this.chatBox.scrollHeight;
        if(!isLoading) AIController.saveHistory(txt, type);
        return b.id;
      },
      removeMessage(id) { const el = document.getElementById(id); if(el) el.parentElement.remove(); },
      saveHistory(txt, type) { let h = JSON.parse(localStorage.getItem('soul_history')||'[]'); h.push({text:txt, type}); if(h.length>20) h=h.slice(-20); localStorage.setItem('soul_history', JSON.stringify(h)); },
      restoreChat() { const h = JSON.parse(localStorage.getItem('soul_history')||'[]'); this.chatBox.innerHTML=''; h.forEach(m=>this.addBubble(m.text, m.type)); },
      clearChatHistory() { if(confirm(Translations[this.lang].clearMsg)) { AIController.clear(); localStorage.removeItem('soul_history'); localStorage.removeItem('soul_user'); location.reload(); } },
      setMode(m) {
        this.currentMode = m; document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
        document.querySelector(`.mode-btn.${m}`).classList.add('active');
        document.documentElement.style.setProperty('--btn-bg', m==='advice'?'#ec4899':'#4c1d95');
      }
    };
    window.onload = () => app.init();
  </script>
</body>
</html>
