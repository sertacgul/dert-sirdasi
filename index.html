<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Soul Confidant</title>

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body {
  margin:0;
  background:#0f172a;
  color:#e5e7eb;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}
.app {
  max-width:600px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
  background:linear-gradient(180deg,#020617,#020617);
}
header {
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #1f2937;
}
.chat {
  flex:1;
  overflow-y:auto;
  padding:16px;
}
.msg {
  max-width:80%;
  padding:12px 16px;
  margin-bottom:12px;
  border-radius:18px;
  line-height:1.4;
}
.user {
  background:#2563eb;
  margin-left:auto;
}
.ai {
  background:#1f2937;
  border:1px solid #334155;
}
.input {
  padding:12px;
  border-top:1px solid #1f2937;
  display:flex;
  gap:8px;
}
textarea {
  flex:1;
  background:#020617;
  color:white;
  border:1px solid #334155;
  border-radius:12px;
  padding:10px;
  resize:none;
}
button {
  background:#ec4899;
  border:none;
  color:white;
  padding:0 18px;
  border-radius:12px;
}
.mode {
  display:flex;
  gap:6px;
  padding:8px;
}
.mode div {
  flex:1;
  text-align:center;
  padding:6px;
  border-radius:8px;
  cursor:pointer;
  font-size:13px;
}
.active {
  background:#1f2937;
  color:#f472b6;
}
</style>
</head>

<body>
<div class="app">

<header>
  <div>
    <strong>Soul Confidant</strong><br>
    <span class="text-xs text-pink-400">A safe place to talk</span>
  </div>
  <i class="fa fa-trash cursor-pointer" onclick="clearAll()"></i>
</header>

<div id="chat" class="chat"></div>

<div class="mode">
  <div id="adviceBtn" class="active" onclick="setMode('advice')">ðŸ’— Vent</div>
  <div id="gossipBtn" onclick="setMode('gossip')">âš¡ Gossip</div>
</div>

<div class="input">
  <textarea id="input" rows="2" placeholder="Type here..."></textarea>
  <button onclick="send()">âž¤</button>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API = "https://dert-sirdasi-api.captsertacgul.workers.dev";
let MODE = "advice";
let LOCK = false;

/* ================= STORAGE ================= */
const HKEY = "sc_history";
const FKEY = "sc_followup";

/* ================= INIT ================= */
loadHistory();
checkFollowup();

/* ================= UI ================= */
function addMsg(text,type){
  const d=document.createElement("div");
  d.className="msg "+type;
  d.innerText=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ================= MODE ================= */
function setMode(m){
  MODE=m;
  adviceBtn.classList.toggle("active",m==="advice");
  gossipBtn.classList.toggle("active",m==="gossip");
}

/* ================= SEND ================= */
async function send(){
  if(LOCK) return;
  const txt=input.value.trim();
  if(!txt) return;

  LOCK=true;
  input.value="";
  addMsg(txt,"user");
  saveHistory("user",txt);
  saveFollowup(txt);

  try{
    const res=await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:txt,mode:MODE})
    });

    if(res.status===429){
      addMsg("You reached todayâ€™s free limit. Come back tomorrow ðŸ«¶","ai");
      LOCK=false; return;
    }

    if(!res.ok) throw new Error();

    const data=await res.json();
    addMsg(data.reply,"ai");
    saveHistory("ai",data.reply);

  }catch{
    addMsg("I couldnâ€™t reach the server. Please try again.","ai");
  }
  LOCK=false;
}

/* ================= HISTORY ================= */
function saveHistory(role,text){
  const h=JSON.parse(localStorage.getItem(HKEY)||"[]");
  h.push({role,text});
  localStorage.setItem(HKEY,JSON.stringify(h.slice(-50)));
}

function loadHistory(){
  const h=JSON.parse(localStorage.getItem(HKEY)||"[]");
  h.forEach(m=>addMsg(m.text,m.role));
  if(h.length===0){
    addMsg("Hello. Iâ€™m here for you. Tell me whatâ€™s on your mind.","ai");
  }
}

function clearAll(){
  localStorage.clear();
  location.reload();
}

/* ================= FOLLOW-UP ================= */
function saveFollowup(text){
  localStorage.setItem(FKEY,JSON.stringify({
    date:new Date().toISOString().slice(0,10),
    topic:text.slice(0,300)
  }));
}

function checkFollowup(){
  const f=JSON.parse(localStorage.getItem(FKEY)||"null");
  if(!f) return;
  const y=new Date(); y.setDate(y.getDate()-1);
  if(f.date===y.toISOString().slice(0,10)){
    setTimeout(()=>{
      addMsg("How did things go with what you shared yesterday?","ai");
    },600);
  }
}
</script>
</body>
</html>
